<!DOCTYPE html>
<html lang="es" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Fiscal 2026</title>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; padding: 40px 20px; color: #1f2937; margin: 0; }
        .menu-wrapper { max-width: 1000px; margin: 0 auto; background: white; padding: 50px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; }
        .menu-title { color: #1e3a8a; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .menu-subtitle { color: #6b7280; font-size: 1.1rem; margin-bottom: 40px; }
        
        /* TARJETAS DEL MEN√ö */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .card { border: 2px solid #e5e7eb; border-radius: 12px; padding: 30px 20px; cursor: pointer; transition: all 0.3s ease; background: white; }
        .card:hover { border-color: #1e3a8a; transform: translateY(-5px); box-shadow: 0 10px 20px rgba(30, 58, 138, 0.1); }
        .card-icon { font-size: 40px; margin-bottom: 15px; display: block; }
        .card h3 { color: #1f2937; margin: 10px 0; font-size: 1.1rem; font-weight: 700; }
        .card p { color: #9ca3af; font-size: 0.85rem; margin: 0; }
        
        /* CONTENEDORES DE APLICACI√ìN */
        .app-container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none; }
        .btn-back { background-color: transparent; color: #64748b; padding: 5px 10px; border-radius: 6px; border: 1px solid #cbd5e1; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px; transition: 0.2s; }
        
        /* FORMULARIOS */
        .section-title { background-color: #e0f2fe; border-left: 5px solid #1e3a8a; padding: 10px 15px; font-weight: bold; margin-top: 30px; margin-bottom: 15px; color: #1e40af; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section-content { display: block; padding: 10px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 5px 5px; margin-bottom: 20px; }
        .hidden { display: none; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-col { flex: 1; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #374151; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        textarea { height: 70px; resize: vertical; }
        .btn-generate { width: 100%; padding: 16px; background-color: #1e3a8a; color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 40px; transition: background 0.2s; }
        .upload-area { background: #f0fdf4; border: 1px dashed #16a34a; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 20px; font-size: 12px; }
        #estadoImagen { font-weight: bold; margin-left: 10px; }
        .text-ok { color: #15803d; } .text-err { color: #b91c1c; }
        
        /* UTILIDADES VISUALES */
        .ref-box { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .btn-small { background: #e0f2fe; color: #1e40af; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px; font-weight: bold; }
        .preview-text { font-size: 13px; color: #059669; font-weight: bold; margin-top: 10px; font-style: italic; background: #d1fae5; padding: 5px; border-radius: 4px; display: none; }
        
        /* CHATBOT */
        .chat-container { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; height: 80vh; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        .chat-header { background-color: #075e54; color: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; }
        .avatar-container { position: relative; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; }
        .avatar { width: 45px; height: 45px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 2; position: relative; }
        .voice-wave { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: rgba(255,255,255,0.3); z-index: 1; opacity: 0; }
        .is-speaking .voice-wave { animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.5); opacity: 0; } }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; background-color: #e5ddd5; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .message { max-width: 80%; padding: 12px 18px; border-radius: 10px; position: relative; font-size: 16px; line-height: 1.5; }
        .bot-msg { align-self: flex-start; background: white; border-radius: 0 15px 15px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user-msg { align-self: flex-end; background: #dcf8c6; border-radius: 15px 0 15px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .input-area { background: #f0f0f0; padding: 15px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; }
        .input-field { flex: 1; padding: 15px; border-radius: 30px; border: 1px solid #fff; outline: none; font-size: 16px; }
        .send-btn { background: #075e54; color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .chat-options { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .chat-option-btn { background: #e0f2f1; color: #00695c; border: 1px solid #b2dfdb; padding: 10px 18px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: 0.2s; }
        #btn-mic { background: #128c7e; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .is-listening { animation: pulse-red 1.5s infinite; background: #dc2626 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        .typing { font-style: italic; color: #888; font-size: 12px; margin-left: 20px; display: none; }
        .audio-control { cursor: pointer; font-size: 20px; margin-right: 15px; }
    </style>
</head>
<body>

    <div id="screen-menu" class="menu-wrapper">
        <h1 class="menu-title">Bienvenida, Mi Amorcito.</h1>
        <p class="menu-subtitle">Sistema de Gesti√≥n Fiscal 2026</p>
        <div class="upload-area"><label>üìÇ Configuraci√≥n:</label><span id="estadoImagen" class="text-err">Buscando logo.png...</span></div>

        <div class="cards-grid">
            <div class="card" onclick="navegar('app-pericias')">
                <span class="card-icon">‚öñÔ∏è</span>
                <h3>Oficio de Pericias</h3>
                <p>Solicitud de peritos contables, etc.</p>
            </div>
            <div class="card" onclick="navegar('app-movilidad')">
                <span class="card-icon">üöó</span>
                <h3>Oficio de Movilidad</h3>
                <p>Solicitud de veh√≠culo institucional.</p>
            </div>
            <div class="card" onclick="navegar('app-atencion')">
                <span class="card-icon">üì®</span>
                <h3>Atenci√≥n de Pedidos</h3>
                <p>Respuesta a solicitudes de informaci√≥n.</p>
            </div>
            <div class="card" onclick="navegar('app-juzgado')">
                <span class="card-icon">üèõÔ∏è</span>
                <h3>Oficio a Juzgado</h3>
                <p>Respuesta con datos de investigados.</p>
            </div>
            <div class="card" onclick="navegar('app-carpeta')">
                <span class="card-icon">üìÇ</span>
                <h3>Carpeta</h3>
                <p>Oficio entrega de carpeta a juzgado</p>
            </div>
            <div class="card" style="background:#e0f2f1; border-color:#075e54;" onclick="navegar('app-voice-assistant')">
                <span class="card-icon">üó£Ô∏è</span>
                <h3 style="color:#075e54;">Asistente de Voz IA</h3>
                <p>Conversaci√≥n interactiva.</p>
            </div>
        </div>
    </div>

    <div id="app-pericias" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Men√∫</button>
        <h1 style="color: #1e3a8a; text-align: center;">Oficio de Pericias</h1>
        <div class="section-title" onclick="toggleSection('p-sec1')">1. Datos Generales ‚ñº</div>
        <div id="p-sec1" class="section-content">
            <div class="form-row"><div class="form-col"><label>N¬∞ Oficio / Carpeta:</label><input type="text" id="p_codigoUnico" placeholder="Ej: 244-2026"></div><div class="form-col"><label>A√±o:</label><input type="text" id="p_anio" value="2026"></div></div>
            <div class="form-row"><div class="form-col"><label>Nombre A√±o (Opcional):</label><input type="text" id="p_nombreAnio"></div></div>
            <div class="form-row"><div class="form-col"><label>D√≠a:</label><select id="p_dia"></select></div><div class="form-col"><label>Mes:</label><select id="p_mes"></select></div></div>
        </div>
        <div class="section-title" onclick="toggleSection('p-sec2')">2. Cuerpo Principal ‚ñº</div>
        <div id="p-sec2" class="section-content">
            <div class="form-row"><div class="form-col"><label>N¬∞ Disposici√≥n:</label><select id="p_numDisposicion"></select></div><div class="form-col"><label>Fecha Disp.:</label><input type="date" id="p_fechaDisposicion"></div></div>
            <div class="form-row"><div class="form-col"><label>Decisi√≥n:</label><select id="p_decision"><option>La AMPLIACI√ìN SUPLEMENTARIA DE LA INVESTIGACI√ìN PREPARATORIA</option><option>INICIO DE DILIGENCIAS PRELIMINARES</option><option>FORMALIZACI√ìN DE LA INVESTIGACI√ìN PREPARATORIA</option></select></div></div>
            <div class="form-row"><div class="form-col"><label>Imputados:</label><input type="text" id="p_imputados"></div></div>
            <div class="form-row" style="background:#f9fafb;padding:10px;"><div class="form-col"><label>Cant. Delitos:</label><select id="p_cantDelitos" onchange="generarDelitosPericias()"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div><div class="form-col"><div id="p_contenedorDelitos"></div></div></div>
            <div class="form-row"><div class="form-col"><label>Plazo:</label><select id="p_plazoActuaciones"></select></div></div>
        </div>
        <div class="section-title" onclick="toggleSection('p-sec3')">3. Datos T√©cnicos ‚ñº</div>
        <div id="p-sec3" class="section-content">
            <div class="form-row"><div class="form-col"><label>Etapa:</label><select id="p_etapaProcesal"><option>Investigaci√≥n Preparatoria</option><option>Diligencias Preliminares</option></select></div><div class="form-col"><label>Vencimiento:</label><input type="date" id="p_plazoVencimiento"></div></div>
            <div class="form-row"><div class="form-col"><label>Involucrados:</label><select id="p_cantInvolucrados"></select></div><div class="form-col"><label>Disp. Ordena:</label><input type="text" id="p_dispoOrdena"></div></div>
        </div>
        <div class="section-title" onclick="toggleSection('p-sec4')">4. Pericias ‚ñº</div>
        <div id="p-sec4" class="section-content"><label>Cantidad:</label><select id="p_cantPericias" onchange="generarCamposPericias()"><option value="0">--</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select><div id="p_contenedorPericias"></div></div>
        <div class="section-title" onclick="toggleSection('p-sec5')">5. Evidencia ‚ñº</div>
        <div id="p-sec5" class="section-content"><label>¬øAdjuntar?</label><select id="p_tieneEvidencia" onchange="toggleEvidencia()"><option value="no">No</option><option value="si">S√≠</option></select><div id="p_boxEvidencia" class="hidden" style="margin-top:10px;"><label>Descripci√≥n:</label><textarea id="p_descEvidencia"></textarea><label>Link:</label><input type="text" id="p_linkEvidencia"></div></div>
        <div class="section-title" onclick="toggleSection('p-sec6')">6. Contacto ‚ñº</div>
        <div id="p-sec6" class="section-content">
            <div class="form-row"><div class="form-col"><label>Mesa Partes:</label><input type="text" id="p_emailMesa" value="fecoflima_1f2d@mpfn.gob.pe"></div><div class="form-col"><label>Fiscal:</label><input type="text" id="p_emailFiscal" value="ncordova@mpfn.gob.pe"></div></div>
            <div class="form-row"><div class="form-col"><label>Tel. Fiscal:</label><input type="text" id="p_telFiscal" value="945 112 224"></div><div class="form-col"><label>Tel. Asistente:</label><input type="text" id="p_telAsistente" value="957 691 331"></div></div>
        </div>
        <button class="btn-generate" onclick="generarWordPericias()">üìÑ GENERAR OFICIO</button>
    </div>

    <div id="app-movilidad" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Men√∫</button>
        <h1 style="color: #1e3a8a; text-align: center;">Solicitud de Movilidad</h1>
        <div class="section-title" onclick="toggleSection('m-sec1')">1. Datos ‚ñº</div>
        <div id="m-sec1" class="section-content">
            <div class="form-row"><div class="form-col"><label>N¬∞ Oficio:</label><input type="text" id="m_numOficio"></div><div class="form-col"><label>Fecha:</label><input type="date" id="m_fechaDocumento"></div></div>
            <div class="form-row"><div class="form-col"><label>Nombre A√±o (Opcional):</label><input type="text" id="m_nombreAnio"></div></div>
        </div>
        <div class="section-title">2. Detalles ‚ñº</div>
        <div class="section-content">
            <label>Destinos:</label><select id="m_cantDestinos" onchange="generarCamposDestinos()"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
            <div id="m_contenedorDestinos"></div>
            <div class="time-box" style="margin-top:10px;">
                <label>Servicio:</label>
                <div class="form-row"><input type="date" id="m_diaServicio" onchange="actualizarPreviewServicio()"><input type="time" id="m_horaInicio" onchange="actualizarPreviewServicio()"><input type="time" id="m_horaFin" onchange="actualizarPreviewServicio()"></div>
                <div id="m_previewServicio" class="preview-text">Selecciona fecha y horas...</div>
            </div>
        </div>
        <div class="section-title" onclick="toggleSection('m-sec4')">4. Contacto ‚ñº</div>
        <div id="m-sec4" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>Celular:</label><select id="m_comboCelular" onchange="toggleManual('m_comboCelular','m_celularManual')"><option value="957691331">957691331 (D√©bora)</option><option value="OTRO">Otro...</option></select><input type="text" id="m_celularManual" style="display:none;"></div>
                <div class="form-col"><label>Asistente:</label><select id="m_comboAsistente" onchange="toggleManual('m_comboAsistente','m_asistenteManual')"><option value="DEBORA JASMIN SOTELO AHUANARI">DEBORA JASMIN SOTELO AHUANARI</option><option value="OTRO">Otro...</option></select><input type="text" id="m_asistenteManual" style="display:none;"></div>
            </div>
        </div>
        <button class="btn-generate" onclick="generarWordMovilidad()">üìÑ GENERAR OFICIO</button>
    </div>

    <div id="app-atencion" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Men√∫</button>
        <h1 style="color: #1e3a8a; text-align: center;">Atenci√≥n de Pedidos</h1>
        
        <div class="section-title" onclick="toggleSection('a-sec1')">1. DATOS GENERALES ‚ñº</div>
        <div id="a-sec1" class="section-content">
            <div class="form-row"><div class="form-col"><label>N¬∞ Oficio:</label><input type="text" id="a_oficio"></div><div class="form-col"><label>Fecha:</label><input type="date" id="a_fecha"></div></div>
            <div class="form-row"><div class="form-col"><label>Nombre A√±o (Opcional):</label><input type="text" id="a_nombreAnio"></div></div>
        </div>
        
        <div class="section-title" onclick="toggleSection('a-sec2')">2. DESTINATARIO ‚ñº</div>
        <div id="a-sec2" class="section-content">
            <div class="form-row"><div class="form-col"><label>T√≠tulo:</label><select id="a_dest_titulo"><option>Sr.</option><option>Dr.</option><option>Sra.</option><option>Dra.</option><option>Sr. Dr.</option><option>Sr. (a) Dr. (a)</option></select></div><div class="form-col"><label>Nombre:</label><input type="text" id="a_dest_nombre"></div></div>
            <label>Cargo:</label><input type="text" id="a_dest_cargo">
        </div>
        
        <div class="section-title" onclick="toggleSection('a-sec3')">3. REFERENCIAS (AVANZADO) ‚ñº</div>
        <div id="a-sec3" class="section-content">
            <div id="container-referencias"></div>
            <button class="btn-small" onclick="agregarReferencia()">+ Agregar Referencia</button>
        </div>
        
        <div class="section-title" onclick="toggleSection('a-sec4')">4. CUERPO ‚ñº</div>
        <div id="a-sec4" class="section-content">
            <label>Responder a:</label><select id="a_ref_respuesta"></select>
            
            <label style="margin-top:10px; color:#047857; font-weight:bold;">Cita Textual del Documento (Opcional):</label>
            <textarea id="a_texto_cita" placeholder='Pegue aqu√≠ el texto (Ej: en relaci√≥n a las investigaciones...). Se insertar√° continuando el p√°rrafo de referencia.' style="height:80px; font-family:'Courier New'; font-size:13px;"></textarea>

            <label style="margin-top:10px;">Saludo:</label>
            <select id="a_saludo"><option>Es grato dirigirme a usted</option><option>Es un honor dirigirme a usted</option></select>
            
            <div style="background:#eff6ff;padding:15px;margin-top:10px;border-radius:5px;">
                <label>¬øTiene Informaci√≥n?</label>
                <select id="a_tieneInfo" onchange="toggleInfoDespacho()"><option value="NO">NO CUENTA</option><option value="SI">S√ç CUENTA</option></select>
                
                <div id="panel-info-no" style="margin-top:10px;">
                    <label>Complemento "NO CUENTA":</label>
                    <select id="a_no_cuenta_detalle">
                        <option value="con investigaciones relacionadas con los hechos materia del requerimiento.">con investigaciones relacionadas con los hechos materia del requerimiento.</option>
                        <option value="con investigaciones relacionadas con las personas naturales y jur√≠dicas antes se√±aladas.">con investigaciones relacionadas con las personas naturales y jur√≠dicas antes se√±aladas.</option>
                    </select>
                </div>

                <div id="panel-info-si" style="display:none;margin-top:10px;">
                    <label>Cant. Carpetas:</label><select id="a_cant_carpetas" onchange="generarCarpetasInputs()"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                    <div id="container-carpetas"></div>
                    <label style="margin-top:10px;">Adjunta:</label><div style="display:flex;gap:10px;"><label><input type="checkbox" id="chk_dispo"> Disposiciones</label><label><input type="checkbox" id="chk_declara"> Declaraciones</label></div>
                </div>
            </div>
        </div>

        <div class="section-title" onclick="toggleSection('a-sec5')">5. PIE DE P√ÅGINA (SIGLAS Y CC) ‚ñº</div>
        <div id="a-sec5" class="section-content">
            <label>Siglas de Redacci√≥n:</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="a_siglas_combo" onchange="toggleManual('a_siglas_combo', 'a_siglas_manual')" style="flex:1;">
                    <option value="NICA/ djsa.">NICA/ djsa.</option>
                    <option value="NICA/ lms.">NICA/ lms.</option>
                    <option value="OTRO">Manual...</option>
                </select>
                <input type="text" id="a_siglas_manual" style="display:none; flex:1;" placeholder="Ej: JUAN/ abcd.">
            </div>

            <label style="margin-top:10px;">Copia (CC):</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="a_cc_combo" onchange="toggleManual('a_cc_combo', 'a_cc_manual')" style="flex:1;">
                    <option value="CC. FSNCEDCF">CC. FSNCEDCF</option>
                    <option value="CC. ARCHIVO">CC. ARCHIVO</option>
                    <option value="OTRO">Manual...</option>
                    <option value="NINGUNO">(Ninguno)</option>
                </select>
                <input type="text" id="a_cc_manual" style="display:none; flex:1;" placeholder="Ej: CC. JEFATURA">
            </div>
        </div>

        <button class="btn-generate" onclick="generarWordAtencion()">üìÑ GENERAR OFICIO</button>
    </div>

    <div id="app-juzgado" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Men√∫</button>
        <h1 style="color: #1e3a8a; text-align: center;">Oficio para Juzgado</h1>

        <div class="section-title" onclick="toggleSection('j-sec1')">1. DATOS DE CABECERA ‚ñº</div>
        <div id="j-sec1" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>N¬∞ Oficio:</label><input type="text" id="j_oficio" placeholder="Ej: 229-2024"></div>
                <div class="form-col"><label>Fecha:</label><input type="date" id="j_fecha"></div>
            </div>
            <div class="form-row"><div class="form-col"><label>Nombre A√±o:</label><input type="text" id="j_anio_nombre"></div></div>
        </div>

        <div class="section-title" onclick="toggleSection('j-sec2')">2. DESTINATARIO Y REFERENCIA ‚ñº</div>
        <div id="j-sec2" class="section-content">
            <div class="form-row">
                <div class="form-col" style="flex: 0 0 180px;">
                    <label>T√≠tulo:</label>
                    <select id="j_titulo_dest">
                        <option value="Sr. Dr.">Sr. Dr.</option>
                        <option value="Sra. Dra.">Sra. Dra.</option>
                        <option value="Sr. (a) Dr. (a)">Sr. (a) Dr. (a)</option>
                        <option value="Sr.">Sr.</option>
                        <option value="Sra.">Sra.</option>
                    </select>
                </div>
                <div class="form-col"><label>Nombre Juez:</label><input type="text" id="j_juez_nombre" placeholder="Ej: WALTHER HUAYLLANI..."></div>
            </div>

            <label style="margin-top:10px">Cargo (Seleccione el Juzgado):</label>
            <div style="display:flex; gap:10px; align-items:center; background:#f0f9ff; padding:10px; border-radius:6px; border:1px solid #bae6fd;">
                <span style="font-weight:bold; font-size:13px;">JUEZ DEL</span>
                <select id="j_numero_juzgado" style="width:220px; font-weight:bold;" onchange="actualizarExpediente()">
                    <option value="01">PRIMER</option>
                    <option value="02">SEGUNDO</option>
                    <option value="29">VIG√âCIMONOVENO</option>
                    <option value="30">TRIG√âCIMO</option>
                </select>
                <span style="font-size:12px;">JUZGADO DE INV. PREPARATORIA...</span>
            </div>
            
            <div class="form-row" style="margin-top:15px">
                <div class="form-col">
                    <label>Expediente N¬∞ (Prefijo Manual + Auto):</label>
                    <div style="display:flex; align-items:center; gap:5px; flex-wrap:wrap;">
                        <input type="text" id="j_exp_prefix" value="02316-2025" style="width:110px; text-align:center; font-weight:bold;">
                        <span style="font-size:14px;">-0-1826-JR-PE-</span>
                        <input type="text" id="j_exp_final" value="01" readonly style="width:50px; background:#e5e7eb; font-weight:bold; text-align:center;">
                    </div>
                </div>
                <div class="form-col"><label>Carpeta Fiscal N¬∞:</label><input type="text" id="j_carpeta"></div>
            </div>
            <div class="form-row">
                <div class="form-col"><label>Casilla SINOE:</label><input type="text" id="j_casilla_juzgado" value="60369"></div>
                <div class="form-col"><label>Resoluci√≥n N¬∞:</label><input type="text" id="j_resolucion" placeholder="Ej: 01"></div>
            </div>
        </div>

        <div class="section-title" onclick="toggleSection('j-sec3')">3. DATOS DE INVESTIGADOS ‚ñº</div>
        <div id="j-sec3" class="section-content">
            <div id="container-investigados"></div>
            <button class="btn-small" onclick="agregarInvestigado()">+ Agregar Investigado</button>
        </div>

        <button class="btn-generate" onclick="generarWordJuzgado()">üìÑ GENERAR OFICIO JUZGADO</button>
    </div>

    <div id="app-carpeta" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Men√∫</button>
        <h1 style="color: #1e3a8a; text-align: center;">Entrega de Carpeta</h1>

        <div class="section-title" onclick="toggleSection('c-sec1')">1. DATOS GENERALES ‚ñº</div>
        <div id="c-sec1" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>N¬∞ Oficio:</label><input type="text" id="c_oficio" placeholder="Ej: 277-2023"></div>
                <div class="form-col"><label>Fecha:</label><input type="date" id="c_fecha"></div>
            </div>
            <div class="form-row"><div class="form-col"><label>Nombre A√±o:</label><input type="text" id="c_anio_nombre"></div></div>
        </div>

        <div class="section-title" onclick="toggleSection('c-sec2')">2. DESTINATARIO ‚ñº</div>
        <div id="c-sec2" class="section-content">
            <label style="background:#eff6ff; padding:8px; display:block; border-radius:5px; cursor:pointer;">
                <input type="checkbox" id="c_check_nombre" onchange="toggleNombreJuez()"> 
                ¬øDirigido a un Juez espec√≠fico? (Opcional)
            </label>
            
            <div id="box-nombre-juez" class="hidden" style="margin-top:10px; margin-left:20px; border-left:3px solid #1e3a8a; padding-left:10px;">
                <div class="form-row">
                    <div class="form-col" style="flex:0 0 100px;">
                        <label>T√≠tulo:</label>
                        <select id="c_titulo_juez"><option>Sr. Dr.</option><option>Sra. Dra.</option></select>
                    </div>
                    <div class="form-col">
                        <label>Nombre Completo:</label>
                        <input type="text" id="c_nombre_juez" placeholder="Ej: JUAN PEREZ">
                    </div>
                </div>
            </div>

            <label style="margin-top:15px;">Juzgado de Destino:</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <span style="font-weight:bold;">JUEZ DEL</span>
                <select id="c_juzgado_num" style="width:200px;" onchange="actualizarExpCarpeta()">
                    <option value="01">PRIMER</option>
                    <option value="02">SEGUNDO</option>
                    <option value="29">VIG√âCIMONOVENO</option>
                    <option value="30">TRIG√âCIMO</option>
                </select>
                <span style="font-size:12px;">JUZGADO DE INV. PREPARATORIA...</span>
            </div>
        </div>

        <div class="section-title" onclick="toggleSection('c-sec3')">3. CONSTRUCCI√ìN DE IMPUTACI√ìN ‚ñº</div>
        <div id="c-sec3" class="section-content">
            <div class="form-row">
                <div class="form-col">
                    <label>Expediente (Sufijo Auto):</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px;">...1826-JR-PE-</span>
                        <input type="text" id="c_exp_sufijo" value="01" style="width:50px; background:#eee;" readonly>
                    </div>
                </div>
                <div class="form-col"><label>Carpeta Fiscal N¬∞:</label><input type="text" id="c_carpeta_num"></div>
            </div>
            
            <label style="margin-top:10px;">Se remite:</label>
            <select id="c_tipo_remite">
                <option value="el Requerimiento de Sobreseimiento">Requerimiento de Sobreseimiento</option>
                <option value="el Requerimiento Acusatorio">Requerimiento Acusatorio</option>
                <option value="el Requerimiento Mixto">Requerimiento Mixto</option>
            </select>

            <hr style="margin: 20px 0; border: 0; border-top: 2px dashed #ccc;">
            
            <label style="font-weight:bold; color:#1e3a8a;">IMPUTADOS Y DELITOS:</label>
            <div id="container-grupos-delito"></div>
            <button class="btn-small" onclick="agregarGrupoDelito()">+ Agregar Grupo de Delito</button>
        </div>

        <div class="section-title" onclick="toggleSection('c-sec4')">4. TABLA DE TOMOS ‚ñº</div>
        <div id="c-sec4" class="section-content">
            <div class="form-row">
                <div class="form-col">
                    <label>Cantidad de Tomos:</label>
                    <select id="c_cant_tomos" onchange="generarTablaTomos()">
                        <option value="0">-- Seleccione --</option>
                        </select>
                </div>
                <div class="form-col">
                    <label>Modo de Folios:</label>
                    <select id="c_tipo_folio" onchange="generarTablaTomos()">
                        <option value="fijo">Autom√°tico (1-200, 201-400...)</option>
                        <option value="manual">Manual (Escribir)</option>
                    </select>
                </div>
            </div>
            <div id="container-tabla-tomos" style="margin-top:15px;"></div>
        </div>

        <div class="section-title" onclick="toggleSection('c-sec5')">5. CIERRE ‚ñº</div>
        <div id="c-sec5" class="section-content">
            <label>Enlace Drive:</label>
            <input type="text" id="c_link" placeholder="https://drive.google.com/...">
            <div class="form-row" style="margin-top:10px;">
                <div class="form-col"><label>SINOE:</label><input type="text" id="c_sinoe" value="60369"></div>
            </div>
        </div>

        <button class="btn-generate" onclick="generarWordCarpeta()">üìÑ GENERAR OFICIO CARPETA</button>
    </div>

    <div id="app-voice-assistant" class="app-container" style="padding:0;">
        <div class="chat-container">
            <div class="chat-header">
                <button class="btn-back" onclick="navegar('screen-menu')" style="margin:0;color:white;border-color:white;">‚¨Ö</button>
                <div class="avatar-container" id="avatar-anim"><div class="voice-wave"></div><div class="avatar">üë©‚Äç‚öñÔ∏è</div></div>
                <div class="header-info" style="margin-left:10px;color:white;"><h2 style="margin:0;font-size:18px;">Asistente</h2><p style="margin:0;font-size:12px;">En l√≠nea</p></div>
                <div style="margin-left:auto;"><span id="btn-audio-toggle" class="audio-control" onclick="toggleAudio()">üîä</span></div>
            </div>
            <div id="chat-box" class="chat-box"></div>
            <div id="typing-indicator" class="typing">Escribiendo...</div>
            <div class="input-area" id="input-area">
                <div id="btn-mic" onclick="clickMicManual()"><svg width="24" height="24" fill="white" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3.5 8V7a.5.5 0 0 1 .5-.5z"/></svg></div>
                <input type="text" id="user-input" class="input-field" placeholder="Escribe..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="enviarRespuesta()">Enviar</button>
            </div>
        </div>
    </div>

<script>
    // =======================================================
    // ===       CONFIGURACI√ìN GLOBAL Y UTILIDADES         ===
    // =======================================================
    const NOMBRE_ARCHIVO_IMAGEN = "logo.png"; 
    let logoArrayBuffer = null;
    let audioEnabled = true;

    // Listas Globales
    const listaOpcionesDelito = ["Colusi√≥n Simple", "Colusi√≥n Agravada", "Negociaci√≥n Incompatible", "Peculado", "Peculado Doloso", "Peculado Culposo", "Tr√°fico de Influencias", "Concusi√≥n", "Cohecho", "Cohecho Pasivo", "Cohecho Activo", "Cohecho Pasivo Propio", "Cohecho Pasivo Impropio", "Usurpaci√≥n de Funciones"];
    const listaPlazos = ["treinta (30) d√≠as naturales", "sesenta (60) d√≠as naturales", "noventa (90) d√≠as naturales", "ciento veinte (120) d√≠as naturales", "ciento cincuenta (150) d√≠as naturales", "ciento ochenta (180) d√≠as naturales"];
    const listaLugares = ["Corte Superior de Lima, Sede Zavala, ubicado en Jir√≥n Manuel Cuadros 182, Lima", "DIRCOCOR PNP, ubicado en Av. Saenz Pe√±a 116 Barranco, Lima", "Sede Central del Ministerio P√∫blico, ubicado en Av. Abancay cuadra 5 S/N"];

 window.onload = function() {
        // 1. Cargar Logo
        try { 
            const xhr=new XMLHttpRequest(); 
            xhr.open('GET',NOMBRE_ARCHIVO_IMAGEN,true); 
            xhr.responseType='arraybuffer'; 
            xhr.onload=function(){if(xhr.status===200)logoArrayBuffer=xhr.response;}; 
            xhr.send(); 
        } catch(e){}

        // 2. ESTABLECER NOMBRE DEL A√ëO AUTOM√ÅTICO (NUEVO)
        const nombreAnioOficial = "A√±o de la Esperanza y el Fortalecimiento de la Democracia";
        
        // Lista de todos los campos de "Nombre A√±o" en las diferentes tarjetas
        const idsAnio = [
            'p_nombreAnio',   // Pericias
            'm_nombreAnio',   // Movilidad
            'a_nombreAnio',   // Atenci√≥n
            'j_anio_nombre',  // Juzgado
            'c_anio_nombre'   // Carpeta
        ];

        // Llenar todos autom√°ticamente
        idsAnio.forEach(id => {
            const input = document.getElementById(id);
            if(input) input.value = nombreAnioOficial;
        });

        // 3. Inicializar resto de funciones
        inicializarPericias();
        inicializarMovilidad();
        if(document.getElementById('container-referencias')) agregarReferencia();
        generarCarpetasInputs();
        
        // Inicializar Carpeta (Tomos y Grupos)
        setTimeout(() => {
            const sel = document.getElementById('c_cant_tomos');
            if(sel && sel.options.length <= 1) { 
                for(let i=1; i<=50; i++) { let opt = document.createElement('option'); opt.value = i; opt.text = i; sel.add(opt); }
            }
            if(typeof contadorGruposDelito !== 'undefined' && document.getElementById('container-grupos-delito') && contadorGruposDelito === 0) {
                agregarGrupoDelito();
            }
        }, 1000);
    };
    function navegar(id) {
        document.querySelectorAll('.menu-wrapper, .app-container').forEach(e => e.style.display='none');
        document.getElementById(id).style.display='block';
        window.scrollTo(0,0);
        if(id==='app-voice-assistant') iniciarChatbot(); else detenerTodoAudio();
    }
    function toggleSection(id){ document.getElementById(id).classList.toggle('hidden'); }

    // =======================================================
    // ===                 L√ìGICA PERICIAS                 ===
    // =======================================================
    function inicializarPericias() { 
        const selMes=document.getElementById('p_mes'); ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"].forEach(m=>{let o=document.createElement('option');o.text=m;selMes.add(o);});
        const selDia=document.getElementById('p_dia'); for(let i=1;i<=31;i++){let o=document.createElement('option');o.text=i;selDia.add(o);}
        const selDisp=document.getElementById('p_numDisposicion'); for(let i=1;i<=100;i++){let o=document.createElement('option');o.text=i.toString().padStart(2,'0');selDisp.add(o);}
        const selInv=document.getElementById('p_cantInvolucrados'); for(let i=1;i<=50;i++){let o=document.createElement('option');o.text=i;selInv.add(o);}
        const selPlazo=document.getElementById('p_plazoActuaciones'); listaPlazos.forEach(p=>{let o=document.createElement('option');o.text=p;selPlazo.add(o);});
        generarDelitosPericias();
    }
    function generarDelitosPericias(){ const c=document.getElementById('p_cantDelitos').value; const d=document.getElementById('p_contenedorDelitos'); d.innerHTML=""; for(let i=0;i<c;i++){let s=document.createElement('select'); s.id=`p_delito_${i}`; s.style.width="100%"; listaOpcionesDelito.forEach(o=>{let opt=document.createElement('option');opt.text=o;s.add(opt);}); d.appendChild(s);}}
    function generarCamposPericias(){ const c=document.getElementById('p_cantPericias').value; const d=document.getElementById('p_contenedorPericias'); d.innerHTML=""; for(let i=1;i<=c;i++){ d.innerHTML+=`<div class="pericia-box"><label>Objeto ${i}:</label><select id="p_tipoPericia_${i}"><option>Perito Contable</option><option>Perito Econ√≥mico</option><option>Perito Forense</option><option>Perito Grafot√©cnico</option></select><textarea id="p_objPericia_${i}" placeholder="Objeto..."></textarea><textarea id="p_detPericia_${i}" placeholder="Detalle..."></textarea></div>`;}}
    function toggleEvidencia(){document.getElementById('p_boxEvidencia').classList.toggle('hidden', document.getElementById('p_tieneEvidencia').value!=='si');}

    // =======================================================
    // ===                 L√ìGICA MOVILIDAD                ===
    // =======================================================
    function inicializarMovilidad() { generarCamposDestinos(); }
    function generarCamposDestinos(){ const c=document.getElementById('m_cantDestinos').value; const d=document.getElementById('m_contenedorDestinos'); d.innerHTML=""; for(let i=1;i<=c;i++){ d.innerHTML+=`<div class="destino-box"><label>Destino ${i}:</label><select id="m_tipoDestino_${i}" onchange="toggleDestinoManual(${i})"><option value="">--Seleccionar--</option>${listaLugares.map(l=>`<option>${l}</option>`).join('')}<option value="OTRO">OTRO</option></select><input type="text" id="m_destinoManual_${i}" style="display:none;"></div>`;}}
    function toggleDestinoManual(i){ const v=document.getElementById(`m_tipoDestino_${i}`).value; document.getElementById(`m_destinoManual_${i}`).style.display=(v==='OTRO')?'block':'none'; }
    function toggleManual(c,i){ const v=document.getElementById(c).value; document.getElementById(i).style.display=(v==='OTRO')?'block':'none'; }
    function actualizarPreviewServicio(){ const f=document.getElementById('m_diaServicio').value; const i=document.getElementById('m_horaInicio').value; const fn=document.getElementById('m_horaFin').value; if(f&&i&&fn){ const d=new Date(f+'T00:00:00'); const ft=d.toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).toUpperCase(); document.getElementById('m_previewServicio').innerText=`${ft}, DE ${i} A ${fn} HORAS`; document.getElementById('m_previewServicio').style.display='block';}}

    // =======================================================
    // ===           L√ìGICA ATENCI√ìN DE PEDIDOS            ===
    // =======================================================
    
    let refCount = 0; 
    const letras = ['a)', 'b)', 'c)', 'd)', 'e)'];

    function agregarReferencia() {
        if(refCount >= 5) return;
        const c = document.getElementById('container-referencias');
        if(!c) return; // Seguridad si estamos en otra pantalla
        const id = refCount;
        
        const div = document.createElement('div');
        div.className = 'ref-box-complex';
        div.style.marginBottom = "10px";
        div.style.padding = "10px";
        div.style.border = "1px solid #e5e7eb";
        div.style.backgroundColor = "#f9fafb";
        div.style.borderRadius = "6px";
        
        div.innerHTML = `
            <div style="font-weight:bold; color:#1e3a8a; margin-bottom:5px;">Referencia ${letras[id]}</div>
            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                <div style="flex:1; min-width:130px;">
                    <select id="ref_pre_combo_${id}" style="width:100%; font-size:12px;" onchange="toggleRefManual('ref_pre_combo_${id}', 'ref_pre_man_${id}')">
                        <option value="OFICIO N.¬∞">OFICIO N.¬∞</option>
                        <option value="OFICIO MULTIPLE">OFICIO MULTIPLE</option>
                        <option value="OFICIO CIRCULAR">OFICIO CIRCULAR</option>
                        <option value="CARTA N.¬∞">CARTA N.¬∞</option>
                        <option value="OTRO">Manual...</option>
                    </select>
                    <input type="text" id="ref_pre_man_${id}" placeholder="Prefijo..." style="display:none; width:100%; margin-top:2px; font-size:12px;">
                </div>
                <div style="flex:1; min-width:100px;">
                    <input type="text" id="ref_num_${id}" placeholder="N√∫mero (Ej: 001-2025)" style="width:100%;" oninput="actualizarComboReferencias()">
                </div>
                <div style="flex:1; min-width:130px;">
                    <select id="ref_suf_combo_${id}" style="width:100%; font-size:12px;" onchange="toggleRefManual('ref_suf_combo_${id}', 'ref_suf_man_${id}')">
                        <option value="-MP-FN-FSNCEDCF">-MP-FN-FSNCEDCF</option>
                        <option value="-MP-FN">-MP-FN</option>
                        <option value="">(Ninguno)</option>
                        <option value="OTRO">Manual...</option>
                    </select>
                    <input type="text" id="ref_suf_man_${id}" placeholder="Sufijo..." style="display:none; width:100%; margin-top:2px; font-size:12px;">
                </div>
            </div>
        `;
        c.appendChild(div);
        refCount++;
        actualizarComboReferencias();
    }

    function toggleRefManual(idCombo, idManual) {
        const val = document.getElementById(idCombo).value;
        document.getElementById(idManual).style.display = (val === 'OTRO') ? 'block' : 'none';
        actualizarComboReferencias();
    }

    function actualizarComboReferencias() {
        const s = document.getElementById('a_ref_respuesta');
        if(!s) return;
        s.innerHTML = '<option value="la referencia">la referencia (General)</option>';
        for(let i=0; i<refCount; i++) {
            const num = document.getElementById(`ref_num_${i}`).value;
            const t = `la referencia ${letras[i]}`;
            const display = num ? `${t} (...${num})` : t;
            const opt = document.createElement('option'); opt.value = t; opt.text = display; s.appendChild(opt);
        }
    }

    function generarCarpetasInputs() {
        const c = document.getElementById('a_cant_carpetas').value;
        const d = document.getElementById('container-carpetas'); d.innerHTML = "";
        for(let i=0; i<c; i++) { d.innerHTML += `<div style="display:flex; align-items:center; margin-bottom:5px;"><span style="margin-right:5px; font-weight:bold;">N.¬∞</span><input type="text" id="a_carpeta_${i}" placeholder="Ej: 50-2024"></div>`; }
    }

    function toggleInfoDespacho() { 
        const val = document.getElementById('a_tieneInfo').value;
        document.getElementById('panel-info-si').style.display = (val==='SI')?'block':'none';
        document.getElementById('panel-info-no').style.display = (val==='NO')?'block':'none';
    }

    // =======================================================
    // ===       L√ìGICA OFICIO JUZGADO (ACTUALIZADA)       ===
    // =======================================================

    let contadorInvestigados = 0;

    function actualizarExpediente() {
        const sel = document.getElementById('j_numero_juzgado');
        const inputExp = document.getElementById('j_exp_final');
        if(sel && inputExp) { inputExp.value = sel.value; }
    }

    function agregarInvestigado() {
        const c = document.getElementById('container-investigados');
        const id = contadorInvestigados;
        
        const html = `
            <div id="inv-${id}" style="background:#f8fafc; border:1px solid #cbd5e1; padding:15px; margin-bottom:15px; border-radius:8px; position:relative;">
                <button onclick="document.getElementById('inv-${id}').remove()" style="position:absolute; right:10px; top:10px; color:red; border:none; background:none; cursor:pointer; font-weight:bold;">‚úñ</button>
                <label style="color:#1e3a8a; font-weight:bold; display:block; margin-bottom:5px;">Investigado ${id + 1}:</label>
                <input type="text" id="j_inv_nombre_${id}" placeholder="NOMBRE COMPLETO" style="font-weight:bold; margin-bottom:10px; border:2px solid #e2e8f0; width:100%;">
                ${crearCampoTags(id, 'cel', 'Celular')}
                <div style="display:flex; gap:5px; margin-bottom:8px; align-items:center; flex-wrap:wrap;">
                    <label style="width:80px; font-size:12px; margin:0;">Abogado:</label>
                    <input type="text" id="j_inv_val_abogado_${id}" style="flex:2; padding:6px; min-width:150px;" placeholder="Nombre del Abogado">
                    <span id="span_reg_${id}" style="font-size:11px; white-space:nowrap; font-weight:bold; color:#444;">con Reg.</span>
                    <input type="text" id="j_inv_colegio_${id}" value="CAL" style="width:40px; padding:4px; text-align:center;" placeholder="Colegio">
                    <span id="span_n_${id}" style="font-size:11px; white-space:nowrap; font-weight:bold; color:#444;">N.¬∞</span>
                    <input type="text" id="j_inv_cal_${id}" style="width:60px; padding:6px;" placeholder="N¬∞">
                    <select id="j_inv_tag_abogado_${id}" style="width:25px; padding:0; font-size:14px;" onchange="verificarAbogado(${id})" title="Marcar como Desconocido"><option value="dato">‚úîÔ∏è</option><option value="NO_INFO">‚ùå</option></select>
                </div>
                ${crearCampoTags(id, 'correo', 'Correo')}
                ${crearCampoSimple(id, 'domicilio', 'Domicilio Real')}
                ${crearCampoSimple(id, 'casilla', 'Casilla Elect.')}
            </div>
        `;
        c.insertAdjacentHTML('beforeend', html);
        contadorInvestigados++;
    }

    function crearCampoTags(id, tipo, label) {
        return `<div style="display:flex; gap:10px; margin-bottom:8px; align-items:center;"><label style="width:80px; font-size:12px; margin:0;">${label}:</label><input type="text" id="j_inv_val_${tipo}_${id}" style="flex:1; padding:6px;" placeholder="Ingrese dato..."><select id="j_inv_tag_${tipo}_${id}" style="width:110px; padding:6px; font-size:11px;" onchange="verificarDesconocido('${tipo}', ${id})"><option value="">(Sin etiqueta)</option><option value="(abogado)">(abogado)</option><option value="(otros)">(otros)</option><option value="NO_INFO">DESCONOCIDO</option></select></div>`;
    }
    function crearCampoSimple(id, tipo, label) {
        return `<div style="display:flex; gap:10px; margin-bottom:8px; align-items:center;"><label style="width:80px; font-size:12px; margin:0;">${label}:</label><input type="text" id="j_inv_val_${tipo}_${id}" style="flex:1; padding:6px;" placeholder="Ingrese dato..."><select id="j_inv_tag_${tipo}_${id}" style="width:25px; padding:0; font-size:14px;" onchange="verificarDesconocido('${tipo}', ${id})" title="Marcar como Desconocido"><option value="dato">‚úîÔ∏è</option><option value="NO_INFO">‚ùå</option></select></div>`;
    }
    function verificarDesconocido(tipo, id) {
        const sel = document.getElementById(`j_inv_tag_${tipo}_${id}`).value;
        const inp = document.getElementById(`j_inv_val_${tipo}_${id}`);
        if (sel === "NO_INFO") { inp.value = "A la fecha no se cuenta con dicha informaci√≥n dado que el investigado a√∫n no se ha apersonado al proceso."; inp.readOnly = true; inp.style.backgroundColor = "#f3f4f6"; inp.style.color = "#666"; inp.style.fontSize = "11px"; } else { if(inp.readOnly) inp.value = ""; inp.readOnly = false; inp.style.backgroundColor = "#fff"; inp.style.color = "#000"; inp.style.fontSize = ""; }
    }
    function verificarAbogado(id) {
        const sel = document.getElementById(`j_inv_tag_abogado_${id}`).value;
        const inpNombre = document.getElementById(`j_inv_val_abogado_${id}`);
        const inpCal = document.getElementById(`j_inv_cal_${id}`); const inpColegio = document.getElementById(`j_inv_colegio_${id}`); const spanReg = document.getElementById(`span_reg_${id}`); const spanN = document.getElementById(`span_n_${id}`);
        if (sel === "NO_INFO") { inpNombre.value = "A la fecha no se cuenta con dicha informaci√≥n dado que el investigado a√∫n no se ha apersonado al proceso."; inpNombre.readOnly = true; inpNombre.style.backgroundColor = "#f3f4f6"; inpNombre.style.fontSize = "11px"; inpCal.style.display = "none"; inpColegio.style.display = "none"; spanReg.style.display = "none"; spanN.style.display = "none"; } 
        else { if(inpNombre.readOnly) inpNombre.value = ""; inpNombre.readOnly = false; inpNombre.style.backgroundColor = "#fff"; inpNombre.style.fontSize = ""; inpCal.style.display = "inline-block"; inpColegio.style.display = "inline-block"; spanReg.style.display = "inline"; spanN.style.display = "inline"; }
    }

    // =======================================================
    // ===       L√ìGICA TARJETA CARPETA (VERIFICADA)       ===
    // =======================================================
    const listaDelitosCorrupcion = ["Concusi√≥n", "Cobro indebido", "Colusi√≥n simple y agravada", "Patrocinio ilegal", "Responsabilidad de peritos, √°rbitros y contadores particulares", "Peculado doloso y culposo", "Peculado de uso", "Malversaci√≥n", "Retardo injustificado de pago", "Rehusamiento a entrega de bienes depositados o puestos en custodia", "Extensi√≥n del tipo", "Soborno internacional pasivo", "Cohecho pasivo impropio", "Cohecho pasivo espec√≠fico", "Cohecho pasivo propio en el ejercicio de la funci√≥n policial o penitenciaria", "Cohecho pasivo impropio en el ejercicio de la funci√≥n policial y penitenciaria", "Corrupci√≥n pasiva de auxiliares jurisdiccionales", "Cohecho activo gen√©rico", "Cohecho activo transnacional", "Cohecho activo espec√≠fico", "Cohecho activo en el √°mbito de la funci√≥n policial", "Inhabilitaci√≥n", "Negociaci√≥n incompatible o aprovechamiento indebido de cargo", "Tr√°fico de influencias"];
    const numerosRomanos = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII", "XIII", "XIV", "XV", "XVI", "XVII", "XVIII", "XIX", "XX", "XXI", "XXII", "XXIII", "XXIV", "XXV", "XXVI", "XXVII", "XXVIII", "XXIX", "XXX", "XXXI", "XXXII", "XXXIII", "XXXIV", "XXXV", "XXXVI", "XXXVII", "XXXVIII", "XXXIX", "XL", "XLI", "XLII", "XLIII", "XLIV", "XLV", "XLVI", "XLVII", "XLVIII", "XLIX", "L"];
    let contadorGruposDelito = 0;

    function toggleNombreJuez() {
        const check = document.getElementById('c_check_nombre').checked;
        document.getElementById('box-nombre-juez').style.display = check ? 'block' : 'none';
    }
    function actualizarExpCarpeta() {
        const sel = document.getElementById('c_juzgado_num');
        if(sel) document.getElementById('c_exp_sufijo').value = sel.value;
    }
    function agregarGrupoDelito() {
        const c = document.getElementById('container-grupos-delito');
        const idG = contadorGruposDelito;
        let optsDelito = listaDelitosCorrupcion.map(d => `<option value="${d}">${d}</option>`).join('');
        const html = `<div id="grupo-delito-${idG}" style="background:#f8fafc; border:1px solid #94a3b8; padding:10px; margin-bottom:15px; border-radius:8px;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><label style="font-weight:bold; color:#0f172a;">DELITO E IMPUTADOS (Grupo ${idG+1})</label>${idG > 0 ? `<button onclick="document.getElementById('grupo-delito-${idG}').remove()" style="color:red;border:none;cursor:pointer;">‚úñ Quitar</button>` : ''}</div><label>Modalidad Delictiva:</label><select id="c_delito_${idG}" style="margin-bottom:10px; font-weight:bold; width:100%;">${optsDelito}</select><div style="background:#fff; padding:10px; border:1px dashed #cbd5e1; border-radius:5px;"><label>Cantidad de Imputados (Max 10):</label><select id="c_cant_inv_${idG}" onchange="renderInvestigados(${idG})"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select><div id="container-inv-grupo-${idG}" style="margin-top:10px;"></div></div></div>`;
        c.insertAdjacentHTML('beforeend', html);
        renderInvestigados(idG); 
        contadorGruposDelito++;
    }
    function renderInvestigados(idG) {
        const cant = document.getElementById(`c_cant_inv_${idG}`).value;
        const cont = document.getElementById(`container-inv-grupo-${idG}`);
        cont.innerHTML = "";
        for(let i=0; i<cant; i++) { cont.innerHTML += `<div style="display:flex; gap:5px; margin-bottom:5px; align-items:center;"><span style="font-size:12px; font-weight:bold;">${i+1}.</span><input type="text" id="c_nom_inv_${idG}_${i}" placeholder="Nombre Completo" style="flex:2;"><select id="c_rol_inv_${idG}_${i}" style="flex:1;" onchange="verificarRolManual(${idG}, ${i})"><option value="(autor)">(autor)</option><option value="(c√≥mplice)">(c√≥mplice)</option><option value="(instigador)">(instigador)</option><option value="OTRO">Otro...</option></select><input type="text" id="c_rol_manual_${idG}_${i}" placeholder="Escribir rol" style="flex:1; display:none;"></div>`; }
    }
    function verificarRolManual(idG, i) {
        const sel = document.getElementById(`c_rol_inv_${idG}_${i}`).value;
        const inp = document.getElementById(`c_rol_manual_${idG}_${i}`);
        inp.style.display = (sel === 'OTRO') ? 'block' : 'none';
    }
    function generarTablaTomos() {
        const cant = parseInt(document.getElementById('c_cant_tomos').value) || 0;
        const tipo = document.getElementById('c_tipo_folio').value;
        const cont = document.getElementById('container-tabla-tomos');
        cont.innerHTML = "";
        if(cant === 0) return;
        cont.innerHTML += `<div style="display:flex; font-weight:bold; background:#e2e8f0; padding:5px;"><div style="flex:0 0 60px; text-align:center;">Tomo</div><div style="flex:1; text-align:center;">Folios</div><div style="flex:1; text-align:center;">Observaciones</div></div>`;
        for(let i=1; i<=cant; i++) {
            let valFolio = "";
            if(tipo === 'fijo') { const inicio = ((i-1) * 200) + 1; const fin = i * 200; valFolio = `${inicio}-${fin}`; }
            cont.innerHTML += `<div style="display:flex; gap:5px; margin-top:5px;"><input type="text" value="${numerosRomanos[i-1] || i}" readonly style="flex:0 0 60px; font-weight:bold; text-align:center; background:#f1f5f9;"><input type="text" id="c_row_folio_${i}" value="${valFolio}" placeholder="Folios" style="flex:1;"><input type="text" id="c_row_obs_${i}" placeholder="-" style="flex:1;"></div>`;
        }
    }

    // =======================================================
    // ===                 ASISTENTE VOZ                   ===
    // =======================================================
    const synth=window.speechSynthesis; const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition; const recognition=SpeechRecognition?new SpeechRecognition():null; if(recognition){recognition.lang='es-PE'; recognition.interimResults=false;}
    let datos={}, pasoActual=0, flujoActual="", preguntasActivas=[], isListening=false, silenceTimer=null;
    const flujos = {
        'INICIO': [{id:'ini',texto:"Hola Debora. Soy su asistente. ¬øQu√© redactamos?",tipo:'opciones',opciones:['Movilidad','Atenci√≥n de Pedidos','Pericias']}],
        'MOVILIDAD': [{id:'m_oficio',texto:"D√≠game el N√∫mero de Oficio.",tipo:'texto'},{id:'m_fecha',texto:"¬øQu√© fecha tiene?",tipo:'fecha'},{id:'m_destinos',texto:"¬øCu√°ntos lugares? ¬øUno, dos o tres?",tipo:'opciones',opciones:['1 Lugar','2 Lugares']},{id:'m_servicio',texto:"Detalle fecha y hora del servicio.",tipo:'texto'},{id:'m_celular',texto:"¬øCelular?",tipo:'opciones_texto',opciones:['957691331']},{id:'m_asistente',texto:"¬øAsistente?",tipo:'opciones_texto',opciones:['DEBORA JASMIN SOTELO AHUANARI']},{id:'fin',texto:"Listo. Generando.",tipo:'final'}],
        'ATENCION': [{id:'a_oficio',texto:"N√∫mero de Oficio de Respuesta.",tipo:'texto'},{id:'a_fecha',texto:"¬øFecha de emisi√≥n?",tipo:'fecha'},{id:'a_dest_nombre',texto:"Nombre del Destinatario.",tipo:'texto'},{id:'a_dest_cargo',texto:"Cargo del Destinatario.",tipo:'texto'},{id:'a_tiene',texto:"¬øEl despacho cuenta con la informaci√≥n? Diga SI o NO.",tipo:'opciones',opciones:['SI','NO']},{id:'a_fin',texto:"Entendido. Generando.",tipo:'final'}],
        'PERICIAS': [{id:'p_codigo',texto:"N√∫mero de Carpeta.",tipo:'texto'},{id:'p_fecha',texto:"Fecha del oficio.",tipo:'fecha'},{id:'p_numDisp',texto:"N√∫mero de Disposici√≥n.",tipo:'texto'},{id:'p_imputado',texto:"Nombre del imputado.",tipo:'texto'},{id:'p_fin',texto:"Generando Pericia B√°sica.",tipo:'final'}]
    };
    function iniciarChatbot(){ document.getElementById('chat-box').innerHTML=''; datos={}; pasoActual=0; flujoActual=""; setTimeout(()=>agregarMensajeBot(flujos.INICIO[0]),800); }
    function agregarMensajeBot(p){ const box=document.getElementById('chat-box'); document.getElementById('typing-indicator').style.display='none'; document.getElementById('input-area').style.display='none'; const d=document.createElement('div'); d.className='message bot-msg'; d.innerHTML=p.texto; 
        if(p.tipo==='opciones'||p.tipo==='opciones_texto'){ const o=document.createElement('div'); o.className='chat-options'; p.opciones.forEach(opt=>{const b=document.createElement('button');b.className='chat-option-btn';b.innerText=opt;b.onclick=()=>procesarRespuesta(opt);o.appendChild(b);}); d.appendChild(o); } 
        if(p.tipo==='final'){ const b=document.createElement('button'); b.className='chat-option-btn'; b.innerText="üìÑ DESCARGAR"; b.onclick=()=>generarDocChat(); d.appendChild(b); } 
        box.appendChild(d); box.scrollTop=box.scrollHeight; hablar(p.texto, ()=>{ if(p.tipo!=='final'){ configurarInput(p); activarEscuchaAutomatica(); } }); 
    }
    function configurarInput(p){ const f=document.getElementById('user-input'); document.getElementById('input-area').style.display='flex'; f.value=''; f.type=p.tipo==='fecha'?'date':'text'; f.focus(); }
    function hablar(t,cb){ if(!audioEnabled){if(cb)cb();return;} synth.cancel(); const u=new SpeechSynthesisUtterance(t.replace(/\*/g,'')); u.lang='es-ES'; u.rate=1.1; u.onstart=()=>document.getElementById('avatar-anim').classList.add('is-speaking'); u.onend=()=>{document.getElementById('avatar-anim').classList.remove('is-speaking');if(cb)cb();}; synth.speak(u); }
    function activarEscuchaAutomatica(){ if(!recognition)return; try{recognition.start(); isListening=true; document.getElementById('btn-mic').classList.add('is-listening'); clearTimeout(silenceTimer); silenceTimer=setTimeout(()=>{if(isListening)detenerEscucha();},10000);}catch(e){} }
    function detenerEscucha(){ if(recognition)recognition.stop(); isListening=false; document.getElementById('btn-mic').classList.remove('is-listening'); clearTimeout(silenceTimer); }
    if(recognition){ recognition.onresult=(e)=>{clearTimeout(silenceTimer); detenerEscucha(); document.getElementById('user-input').value=e.results[0][0].transcript; setTimeout(enviarRespuesta,800);}; recognition.onerror=()=>detenerEscucha(); }
    function procesarRespuesta(t){ 
        const box=document.getElementById('chat-box'); const d=document.createElement('div'); d.className='message user-msg'; d.innerText=t; box.appendChild(d); box.scrollTop=box.scrollHeight; 
        if(!flujoActual){ 
            if(t.toLowerCase().includes('movilidad')){flujoActual='MOVILIDAD'; preguntasActivas=[...flujos.MOVILIDAD]; pasoActual=0; agregarMensajeBot(preguntasActivas[0]);}
            else if(t.toLowerCase().includes('atenc')||t.toLowerCase().includes('pedid')){flujoActual='ATENCION'; preguntasActivas=[...flujos.ATENCION]; pasoActual=0; agregarMensajeBot(preguntasActivas[0]);}
            else if(t.toLowerCase().includes('pericia')){flujoActual='PERICIAS'; preguntasActivas=[...flujos.PERICIAS]; pasoActual=0; agregarMensajeBot(preguntasActivas[0]);}
            else{agregarMensajeBot({texto:"Diga 'Movilidad', 'Atenci√≥n' o 'Pericias'."});} 
        } else { 
            datos[preguntasActivas[pasoActual].id]=t; 
            pasoActual++; if(pasoActual<preguntasActivas.length) agregarMensajeBot(preguntasActivas[pasoActual]); 
        } 
    }
    function enviarRespuesta(){ const v=document.getElementById('user-input').value; if(v)procesarRespuesta(v); }
    function clickMicManual(){ if(isListening)detenerEscucha(); else activarEscuchaAutomatica(); }
    function toggleAudio(){ audioEnabled=!audioEnabled; if(!audioEnabled)detenerTodoAudio(); }
    function detenerTodoAudio(){ synth.cancel(); detenerEscucha(); }
    function handleKeyPress(e){if(e.key==='Enter')enviarRespuesta();}
    function generarDocChat() { 
        if(flujoActual==='MOVILIDAD') generarWordMovilidadChat(); 
        else if(flujoActual==='ATENCION') generarWordAtencionChat();
        else if(flujoActual==='PERICIAS') generarWordPericiasChat();
    }

    // =======================================================
    // ===       GENERADORES WORD (DOCX.JS)                ===
    // =======================================================

    // 1. GENERAR PERICIAS
    function generarWordPericias() {
        const {Document,Packer,Paragraph,TextRun,AlignmentType,UnderlineType,Header}=docx;
        const codigo=document.getElementById('p_codigoUnico').value; const anio=document.getElementById('p_anio').value; const dia=document.getElementById('p_dia').value; const mes=document.getElementById('p_mes').value; const nombreAnio=document.getElementById('p_nombreAnio').value; const fechaTexto=`${dia} de ${mes} del ${anio}`;
        const numDispo=document.getElementById('p_numDisposicion').value; const fechaDispo=formatearFechaLarga(document.getElementById('p_fechaDisposicion').value); const decision=document.getElementById('p_decision').value; const imputados=document.getElementById('p_imputados').value; const plazo=document.getElementById('p_plazoActuaciones').value;
        let delitosArr=[]; for(let i=0;i<document.getElementById('p_cantDelitos').value;i++) delitosArr.push(document.getElementById(`p_delito_${i}`).value); let delitoTexto=delitosArr.join(", ");
        const etapa=document.getElementById('p_etapaProcesal').value; const vencimiento=formatearFechaLarga(document.getElementById('p_plazoVencimiento').value); const involucrados=document.getElementById('p_cantInvolucrados').value; const dispoOrdena=document.getElementById('p_dispoOrdena').value;
        const children=[];
        for (let i = 0; i < 1; i++) { children.push(new Paragraph({text: ""})); }
        children.push(new Paragraph({ alignment: AlignmentType.RIGHT, children: [new TextRun({ text: `Lima, ${fechaTexto}`, size: 24, font: "Times New Roman" })] }));
        children.push(new Paragraph({children:[new TextRun({text:`OFICIO N¬∞ (${codigo}) ${anio}-MP-FN-2D-1FPCEDCF-LIMA.`,bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Times New Roman"})],spacing:{before: 300, after: 0}}));
        children.push(new Paragraph({children:[new TextRun({text:"SE√ëORES:",bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"UNIDAD DE PERITOS FECOF",bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"Ministerio P√∫blico Fiscal√≠a de la Naci√≥n",bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"PRESENTE.-",bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Times New Roman"})],spacing:{line:276, before:0}}));
        children.push(new Paragraph({indent:{left:2835},children:[new TextRun({text:"ASUNTO: SOLICITUD DE DESIGNACI√ìN DE PERITOS",bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(new Paragraph({indent:{left:2835},children:[new TextRun({text:`Referencia: Carpeta Fiscal N.¬∞ ${codigo}`,bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(crearParrafoJustificado([{text:"Tengo a bien dirigirme a usted... con el prop√≥sito de remitir adjunta la disposici√≥n N.¬∞ ",bold:false},{text:numDispo,bold:true}, {text:" de fecha ",bold:false}, {text:fechaDispo,bold:true},{text:", reca√≠da en la carpeta fiscal... ha decidido ",bold:false}, {text:decision,bold:true},{text:", seguida contra ",bold:false}, {text:imputados,bold:true},{text:" por la presunta comisi√≥n del delito de ",bold:false}, {text:delitoTexto,bold:true},{text:", fijando el t√©rmino en ",bold:false}, {text:plazo,bold:true}, {text:".",bold:false}]));
        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        children.push(new Paragraph({ children: [new TextRun({ text: `Respecto de las pericias solicitadas en la Carpeta Fiscal ${codigo}`, underline: { type: UnderlineType.SINGLE }, size: 24, font: "Times New Roman" })], indent: { left: 720 }, alignment: AlignmentType.CENTER, spacing: { line: 276 } }));
        children.push(crearVi√±eta("Etapa procesal: ", etapa)); children.push(crearVi√±eta("Plazo de vencimiento: ", vencimiento)); children.push(crearVi√±eta("Cantidad de involucrados: ", involucrados)); children.push(crearVi√±eta("Disposici√≥n que ordena las pericias: ", "Disposici√≥n N.¬∞ " + dispoOrdena));
        const cantP=document.getElementById('p_cantPericias').value;
        for(let i=1; i<=cantP; i++){ let tipo=document.getElementById(`p_tipoPericia_${i}`).value; let obj=document.getElementById(`p_objPericia_${i}`).value; let det=document.getElementById(`p_detPericia_${i}`).value; children.push(new Paragraph({children:[new TextRun({text:`${i}. RESPECTO DE LA PERICIA ${tipo}`,bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}})); children.push(crearParrafoJustificado([{text:obj,bold:false}])); if(det) children.push(crearParrafoJustificado([{text:det,bold:false}])); }
        if(document.getElementById('p_tieneEvidencia').value==='si'){ children.push(new Paragraph({children:[new TextRun({text:"INDICACI√ìN DE LA EVIDENCIA QUE SE ADJUNTA",bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}})); children.push(crearParrafoJustificado([{text:document.getElementById('p_descEvidencia').value,bold:false}])); children.push(new Paragraph({children:[new TextRun({text:document.getElementById('p_linkEvidencia').value,color:"0000FF",underline:{type:UnderlineType.SINGLE},size:24,font:"Times New Roman"})],alignment:AlignmentType.CENTER,spacing:{line:276}})); }
        children.push(new Paragraph({children:[new TextRun({text:"De manera que, tras la designaci√≥n del perito... este se deber√° poner en contacto...",size:24,font:"Times New Roman"})],spacing:{line:276}})); children.push(new Paragraph({text:"\n\n"})); children.push(crearTablaContacto(document.getElementById('p_emailMesa').value,document.getElementById('p_emailFiscal').value,document.getElementById('p_telFiscal').value,document.getElementById('p_telAsistente').value)); children.push(new Paragraph({text:"\n\n"})); children.push(new Paragraph({children:[new TextRun({text:"Atentamente,",size:24,font:"Times New Roman"})],alignment:AlignmentType.CENTER}));
        crearYDescargarDoc(children, construirEncabezado(logoArrayBuffer, "", nombreAnio), `OFICIO N.¬∞-${codigo}-MP-FN-2D-1¬∞FPCEDCF-LIMA.docx`);
    }

    // 2. GENERAR MOVILIDAD
    function generarWordMovilidad() {
        const {Document,Packer,Paragraph,TextRun,AlignmentType,UnderlineType,Header}=docx;
        const oficio=document.getElementById('m_numOficio').value; const nombreAnio=document.getElementById('m_nombreAnio').value; const fecha=formatearFechaLarga(document.getElementById('m_fechaDocumento').value);
        const children=[];
        for (let i = 0; i < 1; i++) { children.push(new Paragraph({text: ""})); }
        children.push(new Paragraph({ alignment: AlignmentType.RIGHT, children: [new TextRun({ text: `Lima, ${fecha}`, bold: true, size: 24, font: "Times New Roman" })] }));
        children.push(new Paragraph({children:[new TextRun({text:`OFICIO N.¬∞ ${oficio}-MP-FN-2D-1¬∞FPCEDCF-LIMA.`,bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Times New Roman"})],spacing:{before: 300, after: 0}}));
        children.push(new Paragraph({children:[new TextRun({text:"Sr. Dr.",bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"MIRKO DINO CANO GAMERO",bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"FISCAL ADJUNTO SUPREMO TITULAR COORDINADOR NACIONAL DE LAS FISCAL√çAS ESPECIALIZADAS EN DELITOS DE CORRUPCI√ìN DE FUNCIONARIOS.",bold:true,size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"PRESENTE.-",bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Times New Roman"})],spacing:{line:276,before:0}}));
        children.push(new Paragraph({text:"",spacing:{line:276}}));
        children.push(new Paragraph({indent:{left:2835},children:[new TextRun({text:"ASUNTO: SOLICITUD DE ATENCI√ìN DE MOVILIDAD",bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Times New Roman"})],spacing:{line:276}}));
        children.push(new Paragraph({text:"",spacing:{line:276}}));
        const cant=document.getElementById('m_cantDestinos').value; let dests=[]; for(let i=1;i<=cant;i++){let v=document.getElementById(`m_tipoDestino_${i}`).value; if(v==='OTRO')v=document.getElementById(`m_destinoManual_${i}`).value; if(v)dests.push(v);}
        let destTxt=dests.join("; "); let serv=document.getElementById('m_previewServicio').innerText; if(serv.includes('Selecciona')) serv="FECHA POR DEFINIR";
        children.push(crearParrafoJustificado([{text:"Tengo el honor de dirigirme a usted, a fin de saludarlo cordialmente, y a su vez, SOLICITAR, la asignaci√≥n de una movilidad (Veh√≠culo institucional) para nuestro despacho Fiscal, con el fin de poder trasladarnos a: ",bold:false},{text:destTxt,bold:true},{text:"; y as√≠ dar cumplimiento con las diligencias pendientes, por lo que se solicita apoyo con car√°cter de ",bold:false},{text:"MUY URGENTE",bold:true}, {text:", el veh√≠culo institucional.",bold:false}]));
        children.push(new Paragraph({text:""}));
        children.push(crearParrafoJustificado([{text:"En ese sentido, el 2¬∞ Despacho de la 1¬∞ Fiscal√≠a Provincial Corporativa Especializada en Delitos de Corrupci√≥n de Funcionarios de Lima Centro, cumple con ",bold:false}, {text:"SOLICITAR",bold:true},{text:" que nos ASIGNEN un veh√≠culo para el d√≠a ",bold:false}, {text:serv,bold:true}, {text:".",bold:false}]));
        children.push(new Paragraph({text:""}));
        let cel=document.getElementById('m_comboCelular').value; if(cel==='OTRO')cel=document.getElementById('m_celularManual').value;
        let asis=document.getElementById('m_comboAsistente').value; if(asis==='OTRO')asis=document.getElementById('m_asistenteManual').value;
        children.push(crearParrafoJustificado([{text:"Para efectos de la confirmaci√≥n de la solicitud, y de toda coordinaci√≥n, se pone de conocimiento el correo de Mesa de Partes del Despacho: ",bold:false}, {text:"fecoflima_1f2d@mpfn.gob.pe",bold:true},{text:"; as√≠ como el tel√©fono celular N¬∞ ",bold:false}, {text:cel,bold:true},{text:" perteneciente a la Asistente en Funci√≥n Fiscal ",bold:false}, {text:asis,bold:true}, {text:".",bold:false}]));
        children.push(new Paragraph({text:""}));
        children.push(crearParrafoJustificado([{text:"Sin otro particular, aprovecho la ocasi√≥n para expresarle las muestras de mi especial consideraci√≥n y estima personal.",bold:false}]));
        children.push(new Paragraph({text:"\n\n"}));
        children.push(new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Atentamente,",size:24,font:"Times New Roman"})]}));
        crearYDescargarDoc(children, construirEncabezado(logoArrayBuffer, "", nombreAnio), `OFICIO N.¬∞-${oficio}-MP-FN-2D-1¬∞FPCEDCF-LIMA.docx`);
    }

    // 3. GENERAR ATENCI√ìN (FULL OPCIONES)
    function generarWordAtencion() {
        const { Document, Packer, Paragraph, TextRun, AlignmentType, UnderlineType, Header } = docx;
        const nombreAnio = document.getElementById('a_nombreAnio').value; const fechaRaw = document.getElementById('a_fecha').value; const fechaTexto = fechaRaw ? formatearFechaLarga(fechaRaw) : "_______"; const oficioNum = document.getElementById('a_oficio').value; const oficioFull = `${oficioNum}-MP-FN-2D-1¬∞FPCEDCF-LIMA.`;
        const tituloDest = document.getElementById('a_dest_titulo').value; const destinatario = document.getElementById('a_dest_nombre').value; const cargo = document.getElementById('a_dest_cargo').value; const saludo = document.getElementById('a_saludo').value; const tieneInfo = document.getElementById('a_tieneInfo').value; const refSeleccionadaTexto = document.getElementById('a_ref_respuesta').value; const textoCita = document.getElementById('a_texto_cita').value; 
        let refsArr = []; 
        for(let i=0; i<refCount; i++) { 
            let pre = document.getElementById(`ref_pre_combo_${i}`).value; if(pre === 'OTRO') pre = document.getElementById(`ref_pre_man_${i}`).value;
            let num = document.getElementById(`ref_num_${i}`).value;
            let suf = document.getElementById(`ref_suf_combo_${i}`).value; if(suf === 'OTRO') suf = document.getElementById(`ref_suf_man_${i}`).value;
            if(num) { let textoRef = `${pre} ${num}${suf}`; refsArr.push({letra:letras[i], texto:textoRef}); }
        }
        let refString = refsArr.map(r => `${r.letra} ${r.texto}`).join("  ");
        const children = [];
        for (let i = 0; i < 1; i++) { children.push(new Paragraph({text: ""})); }
        children.push(new Paragraph({ alignment: AlignmentType.RIGHT, children: [new TextRun({ text: `Lima, ${fechaTexto}`, size: 24, font: "Times New Roman" })] }));
        children.push(new Paragraph({ children:[new TextRun({text:`OFICIO N.¬∞ ${oficioFull}`, bold:true, underline:{type:UnderlineType.SINGLE}, size:24, font:"Times New Roman"})], spacing:{before: 300, after: 0} }));
        children.push(new Paragraph({children:[new TextRun({text:`${tituloDest}`, bold:true, size:24, font:"Times New Roman"})], spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:destinatario, bold:true, size:24, font:"Times New Roman"})], spacing:{line:276}}));
        children.push(new Paragraph({ alignment: AlignmentType.JUSTIFIED, children:[new TextRun({text:cargo, size:20, font:"Times New Roman"})], spacing:{line:276} }));
        children.push(new Paragraph({ alignment: AlignmentType.JUSTIFIED, children:[new TextRun({text:"PRESENTE.-", bold:true, underline:{type:UnderlineType.SINGLE}, size:24, font:"Times New Roman"})], spacing:{line:276, before: 0} }));
        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        children.push(new Paragraph({ alignment: AlignmentType.JUSTIFIED, indent: { left: 2835 }, children: [ new TextRun({ text: "ASUNTO:", bold: true, underline:{type:UnderlineType.SINGLE}, size:24, font: "Times New Roman" }), new TextRun({ text: " ATIENDE PEDIDO DE INFORMACI√ìN", bold:false, size:24, font: "Times New Roman" }) ], spacing: { line: 276 } }));
        if(refString) { children.push(new Paragraph({ alignment: AlignmentType.JUSTIFIED, indent: { left: 2835 }, children: [ new TextRun({ text: "Referencia:", bold: true, underline:{type:UnderlineType.SINGLE}, size:24, font: "Times New Roman" }), new TextRun({ text: refString, size: 24, font: "Times New Roman" }) ], spacing: { line: 276 } })); }
        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        
        // Cuerpo y Cita Textual
        let cuerpoParts = [ {text: `${saludo} a usted, en mi condici√≥n de Fiscal Provincial del Segundo Despacho de la Primera Fiscal√≠a Provincial Corporativa Especializada en Delitos de Corrupci√≥n de Funcionarios de Lima Centro, y en atenci√≥n a lo solicitado en el documento de `, bold: false}, {text: refSeleccionadaTexto, bold: false} ];
        
        if(textoCita && textoCita.trim() !== "") {
            // Se a√±ade la cita a continuaci√≥n, mismo formato
            cuerpoParts.push({text: ` "${textoCita}"`, bold: false});
        }
        
        cuerpoParts.push({text: ", ", bold: false}); // Coma de continuaci√≥n
        
        let cuerpoResp = [{text: "Este despacho fiscal ", bold: false}, {text: "CUMPLE CON INFORMAR", bold: true}];
        if(tieneInfo === "NO") { const detalleNo = document.getElementById('a_no_cuenta_detalle').value; cuerpoResp.push({text: " que ", bold: false}); cuerpoResp.push({text: "NO CONTAMOS", bold: true}); cuerpoResp.push({text: " " + detalleNo, bold: false}); }
        else { const cantCarp = document.getElementById('a_cant_carpetas').value; let carpetasArr = []; for(let i=0; i<cantCarp; i++) { let v = document.getElementById(`a_carpeta_${i}`).value; if(v) carpetasArr.push(`N.¬∞ ${v}`); } let carpetasTexto = carpetasArr.join(" y "); cuerpoResp.push({text: " que este despacho ", bold: false}); cuerpoResp.push({text: "S√ç CUENTA", bold: true}); cuerpoResp.push({text: " con investigaciones relacionadas con los hechos materia del requerimiento, encontr√°ndose los mismos comprendidos en las Carpetas Fiscales ", bold: false}); cuerpoResp.push({text: carpetasTexto, bold: true}); cuerpoResp.push({text: ".", bold: false}); }
        
        // Imprimimos primer p√°rrafo (con la cita integrada)
        children.push(crearParrafoJustificado(cuerpoParts));
        // Imprimimos p√°rrafo de respuesta
        children.push(crearParrafoJustificado(cuerpoResp));

        if(tieneInfo === "SI") { const d = document.getElementById('chk_dispo').checked; const dc = document.getElementById('chk_declara').checked; let adj = ""; if(d && dc) adj = "las disposiciones fiscales y declaraciones pertinentes"; else if(d) adj = "las disposiciones fiscales pertinentes"; else if(dc) adj = "las declaraciones pertinentes"; if(adj) { children.push(new Paragraph({ text: "" })); children.push(crearParrafoJustificado([{text: "En tal sentido, se adjuntan ", bold: false}, {text: adj, bold: false}, {text: " para conocimiento y fines correspondientes.", bold: false}])); } }
        children.push(new Paragraph({ text: "" }));
        children.push(crearParrafoJustificado([{text: "Sin otro particular, renuevo a usted las expresiones de mi especial consideraci√≥n y estima personal.", bold: false}]));
        children.push(new Paragraph({ text: "\n\n" }));
        children.push(new Paragraph({ children: [new TextRun({ text: "Atentamente,", size: 24, font: "Times New Roman" })], alignment: AlignmentType.CENTER }));
        children.push(new Paragraph({ text: "\n\n" }));
        let siglas = document.getElementById('a_siglas_combo').value; if(siglas === 'OTRO') siglas = document.getElementById('a_siglas_manual').value;
        let cc = document.getElementById('a_cc_combo').value; if(cc === 'OTRO') cc = document.getElementById('a_cc_manual').value;
        if(siglas) { children.push(new Paragraph({ children: [new TextRun({ text: siglas, bold: true,size: 20, font: "Times New Roman" })] })); }
        if(cc && cc !== "NINGUNO") { children.push(new Paragraph({ children: [new TextRun({ text: cc, size: 20, font: "Times New Roman" })] })); }
        crearYDescargarDoc(children, construirEncabezado(logoArrayBuffer, "", nombreAnio), `OFICIO N.¬∞-${oficioNum}-MP-FN-2D-1¬∞FPCEDCF-LIMA.docx`);
    }

    // 4. GENERAR JUZGADO (ACTUALIZADO)
    function generarWordJuzgado() {
        const { Paragraph, TextRun, AlignmentType, UnderlineType } = docx;
        const oficio = document.getElementById('j_oficio').value; const fecha = formatearFechaLarga(document.getElementById('j_fecha').value); const anioNombre = document.getElementById('j_anio_nombre').value;
        const tituloDest = document.getElementById('j_titulo_dest').value; const juezNombre = document.getElementById('j_juez_nombre').value;
        const selJuzgado = document.getElementById('j_numero_juzgado'); const txtJuzgado = selJuzgado.options[selJuzgado.selectedIndex].text; const juezCargo = `JUEZ DEL ${txtJuzgado} JUZGADO DE INVESTIGACI√ìN PREPARATORIA DE CORRUPCI√ìN DE FUNCIONARIOS Y CRIMEN ORGANIZADO DE LA CORTE SUPERIOR DE JUSTICIA DE LIMA.`;
        const expPrefix = document.getElementById('j_exp_prefix').value; const expSufijo = document.getElementById('j_exp_final').value; const expediente = `${expPrefix}-0-1826-JR-PE-${expSufijo}`;
        const carpeta = document.getElementById('j_carpeta').value; const casillaJuzgado = document.getElementById('j_casilla_juzgado').value; const resolucion = document.getElementById('j_resolucion').value;
        const children = [];
        for(let i=0; i<1; i++) children.push(new Paragraph({text:""})); 
        children.push(new Paragraph({ alignment: AlignmentType.RIGHT, children: [new TextRun({ text: `Lima, ${fecha}`, bold: true, size: 24, font: "Times New Roman" })] }));
        children.push(new Paragraph({ children: [new TextRun({ text: `OFICIO N. ¬∫ ${oficio}-MP-FN-2¬∫DF-1¬∫ FPCEDCF-LIMA`, bold: true, underline: { type: UnderlineType.SINGLE }, size: 24, font: "Times New Roman" })], spacing: { before: 300, after: 0 } }));
        children.push(new Paragraph({ children: [new TextRun({ text: tituloDest, bold: true, size: 24, font: "Times New Roman" })] })); children.push(new Paragraph({ children: [new TextRun({ text: juezNombre, bold: true, size: 24, font: "Times New Roman" })] })); children.push(new Paragraph({ children: [new TextRun({ text: juezCargo, bold: true, size: 24, font: "Times New Roman" })] }));
        children.push(new Paragraph({ children: [new TextRun({ text: "Presente. ‚Äì", size: 24, font: "Times New Roman" })], spacing: { before: 0, after: 200 } }));
        const indentRef = 4500; 
        children.push(new Paragraph({ indent: { left: indentRef }, children: [ new TextRun({ text: "Referencia: ", bold: true, size: 24, font: "Times New Roman" }), new TextRun({ text: `a) Expediente N.¬∫ ${expediente}`, size: 24, font: "Times New Roman" }) ] }));
        children.push(new Paragraph({ indent: { left: indentRef }, children: [ new TextRun({ text: "", size: 24, font: "Times New Roman" }),  new TextRun({ text: `b) Carpeta Fiscal N. ¬∫ ${carpeta}`, size: 24, font: "Times New Roman" }) ] }));
        children.push(new Paragraph({ indent: { left: indentRef }, children: [ new TextRun({ text: "Casilla Electr√≥nica: ", bold: true, size: 24, font: "Times New Roman" }), new TextRun({ text: `SINOE N. ¬∫ ${casillaJuzgado}`, size: 24, font: "Times New Roman" }) ], spacing: { after: 300 } }));
        children.push(crearParrafoJustificado([ { text: "Tengo el agrado de dirigirme a usted, a fin de saludarle cordialmente y a su vez, ", bold: false }, { text: "RESPONDER", bold: true }, { text: `, a lo solicitado por su judicatura a trav√©s de la Resoluci√≥n N.¬∫ ${resolucion}, respecto al expediente de la referencia. En ese sentido este Despacho Fiscal informa los siguientes datos actualizados de los investigados:`, bold: false } ]));
        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        const inputsNombre = document.querySelectorAll('[id^="j_inv_nombre_"]'); let indexEnum = 1;
        inputsNombre.forEach((input) => {
            const id = input.id.split('_')[3]; const nombre = input.value;
            if(nombre) {
                children.push(new Paragraph({ children: [new TextRun({ text: `${indexEnum}. ${nombre.toUpperCase()}:`, bold: true, size: 24, font: "Times New Roman" })], spacing: { before: 200 } }));
                const campos = [ {key: 'cel', label: 'Celular'}, {key: 'abogado', label: 'Abogado'}, {key: 'correo', label: 'Correo'}, {key: 'domicilio', label: 'Domicilio Real'}, {key: 'casilla', label: 'Casilla Electr√≥nica'} ];
                campos.forEach(c => {
                    let val = document.getElementById(`j_inv_val_${c.key}_${id}`).value || "---";
                    if (c.key === 'abogado') {
                        const tagAbogado = document.getElementById(`j_inv_tag_abogado_${id}`).value; const calInput = document.getElementById(`j_inv_cal_${id}`); const colegioInput = document.getElementById(`j_inv_colegio_${id}`);
                        if (tagAbogado !== "NO_INFO" && calInput && calInput.value) { const nombreColegio = colegioInput.value || "CAL"; val += ` con Reg. ${nombreColegio} N.¬∞ ${calInput.value}`; }
                    } else if (c.key === 'cel' || c.key === 'correo') { const tagSelect = document.getElementById(`j_inv_tag_${c.key}_${id}`); if (tagSelect) { const tag = tagSelect.value; if(tag && tag !== "NO_INFO" && tag !== "dato") {  val += ` ${tag}`; } } }
                    children.push(new Paragraph({ indent: { left: 720 }, children: [ new TextRun({ text: `${c.label}: `, bold: true, size: 24, font: "Times New Roman" }), new TextRun({ text: val, size: 24, font: "Times New Roman" }) ], spacing: { line: 276 } }));
                });
                indexEnum++;
            }
        });
        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        children.push(crearParrafoJustificado([{ text: "Sin otro particular, hago propicia la oportunidad para expresarle los sentimientos de mi especial consideraci√≥n y estima personal.", bold: false }]));
        children.push(new Paragraph({ text: "\n\n" }));
        children.push(new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: "Atentamente,", size: 24, font: "Times New Roman" })] }));
        crearYDescargarDoc(children, construirEncabezado(logoArrayBuffer, "", anioNombre), `OFICIO N.¬∞-${oficio}-MP-FN-2D-1¬∞FPCEDCF-LIMA.docx`);
    }

    // 5. GENERAR CARPETA
    function generarWordCarpeta() {
        const { Paragraph, TextRun, AlignmentType, UnderlineType, Table, TableRow, TableCell, WidthType, BorderStyle } = docx;
        const oficio = document.getElementById('c_oficio').value; const fecha = formatearFechaLarga(document.getElementById('c_fecha').value); const anioNombre = document.getElementById('c_anio_nombre').value;
        const incluirNombre = document.getElementById('c_check_nombre').checked; const tituloJuez = document.getElementById('c_titulo_juez').value; const nombreJuez = document.getElementById('c_nombre_juez').value.toUpperCase();
        const selJuzgado = document.getElementById('c_juzgado_num'); const txtJuzgado = selJuzgado.options[selJuzgado.selectedIndex].text; const cargoJuzgado = `JUEZ DEL ${txtJuzgado} JUZGADO DE INVESTIGACI√ìN PREPARATORIA ESPECIALIZADO EN DELITOS DE CORRUPCI√ìN DE FUNCIONARIOS Y CRIMEN ORGANIZADO DE LIMA ‚Äì SEDE ZAVALA`;
        const expSufijo = document.getElementById('c_exp_sufijo').value; const expediente = `00079-2025-0-1826-JR-PE-${expSufijo}`; const carpeta = document.getElementById('c_carpeta_num').value; const tipoRemite = document.getElementById('c_tipo_remite').value; const link = document.getElementById('c_link').value; const sinoe = document.getElementById('c_sinoe').value;
        const children = [];
        for(let i=0; i<1; i++) children.push(new Paragraph({text:""}));
        children.push(new Paragraph({ alignment: AlignmentType.RIGHT, children: [new TextRun({ text: `Lima, ${fecha}`, bold: true, size: 24, font: "Times New Roman" })] }));
        children.push(new Paragraph({ children: [new TextRun({ text: `OFICIO N¬∞ (${oficio}) -MP-FN-2D-1FPCEDCF-LIMA.`, bold: true, underline: { type: UnderlineType.SINGLE }, size: 24, font: "Times New Roman" })], spacing: { before: 300, after: 0 } }));
        children.push(new Paragraph({ children: [new TextRun({ text: "Sr.", bold: true, size: 24, font: "Times New Roman" })] }));
        if (incluirNombre && nombreJuez) { children.push(new Paragraph({ children: [new TextRun({ text: `${tituloJuez} ${nombreJuez}`, bold: true, size: 24, font: "Times New Roman" })] })); }
        children.push(new Paragraph({ children: [new TextRun({ text: cargoJuzgado, bold: true, size: 24, font: "Times New Roman" })] }));
        children.push(new Paragraph({ children: [new TextRun({ text: "PRESENTE.-", size: 24, font: "Times New Roman" })], spacing: { before: 0, after: 200 } }));
        const indentRef = 4252; 
        children.push(new Paragraph({ indent: { left: indentRef }, children: [ new TextRun({ text: `Expediente N.¬∞ ${expediente}`, bold: true, size: 24, font: "Times New Roman" }) ] }));
        children.push(new Paragraph({ indent: { left: indentRef }, children: [new TextRun({ text: `Referencia: Carpeta Fiscal N.¬∫ ${carpeta}`, bold: true, size: 24, font: "Times New Roman" })], spacing: { after: 300 } }));
        let textoImputacion = "";
        const gruposDivs = document.querySelectorAll('[id^="grupo-delito-"]');
        gruposDivs.forEach((grupo, index) => {
            const idG = grupo.id.split('-')[2]; const delito = document.getElementById(`c_delito_${idG}`).value; const cantInv = document.getElementById(`c_cant_inv_${idG}`).value;
            let listaNombres = [];
            for(let i=0; i<cantInv; i++){ const nom = document.getElementById(`c_nom_inv_${idG}_${i}`).value.toUpperCase(); let rol = document.getElementById(`c_rol_inv_${idG}_${i}`).value; if(rol === 'OTRO') rol = document.getElementById(`c_rol_manual_${idG}_${i}`).value; if(nom) listaNombres.push(`${nom} ${rol}`); }
            if(listaNombres.length > 0) { const conector = (index === 0) ? "seguida contra " : "; y en contra de "; const nombresStr = listaNombres.join(", "); textoImputacion += `${conector}${nombresStr} ,por la presunta comisi√≥n del delito contra la Administraci√≥n P√∫blica, en la modalidad de ${delito.toUpperCase()}`; }
        });
        if(textoImputacion) { textoImputacion += " en agravio del Estado."; }
        children.push(crearParrafoJustificado([ { text: "Tengo el agrado de dirigirme a usted a fin de saludarlo cordialmente, y a su vez ", bold: false }, { text: "REMITIRLE, ", bold: true }, { text: `${tipoRemite}; ${textoImputacion}`, bold: false } ]));
        const cantTomos = parseInt(document.getElementById('c_cant_tomos').value) || 0;
        children.push(crearParrafoJustificado([ { text: `Asimismo, se remite el √≠ntegro de la Carpeta Fiscal N.¬∞ ${carpeta} (${cantTomos} Tomos principales). La misma que se encuentra detallada de la siguiente manera:`, bold: false } ]));
        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        if(cantTomos > 0) {
            const tableRows = [];
            tableRows.push(new TableRow({ children: [ crearCeldaTabla("TOMO", true), crearCeldaTabla("FOLIOS", true), crearCeldaTabla("OBSERVACIONES", true) ] }));
            for(let i=1; i<=cantTomos; i++) {
                const romano = numerosRomanos[i-1] || i; const folios = document.getElementById(`c_row_folio_${i}`).value || "-"; const obs = document.getElementById(`c_row_obs_${i}`).value || "-";
                tableRows.push(new TableRow({ children: [ crearCeldaTabla(romano, false), crearCeldaTabla(folios, false), crearCeldaTabla(obs, false) ] }));
            }
            const table = new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: tableRows, borders: { top: { style: BorderStyle.SINGLE, size: 1 }, bottom: { style: BorderStyle.SINGLE, size: 1 }, left: { style: BorderStyle.SINGLE, size: 1 }, right: { style: BorderStyle.SINGLE, size: 1 }, insideHorizontal: { style: BorderStyle.SINGLE, size: 1 }, insideVertical: { style: BorderStyle.SINGLE, size: 1 } } });
            children.push(table); children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        }
        if(link) { children.push(crearParrafoJustificado([{ text: "Asimismo, se remite el enlace con los elementos de convicci√≥n para ser visualizados y descargados:", bold: false }])); children.push(new Paragraph({ children: [new TextRun({ text: link, color: "0000FF", underline: { type: UnderlineType.SINGLE }, size: 24, font: "Times New Roman" })] })); }
        children.push(crearParrafoJustificado([{ text: `Para efectos de notificaci√≥n se consigna la casilla electr√≥nica SINOE N.¬∞ ${sinoe}.`, bold: false }]));
        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        children.push(crearParrafoJustificado([{ text: "Sin otro particular, hago propicia la oportunidad para expresarle los sentimientos de mi especial consideraci√≥n y estima personal.", bold: false }]));
        children.push(new Paragraph({ text: "\n\n" }));
        children.push(new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: "Atentamente,", size: 24, font: "Times New Roman" })] }));
        crearYDescargarDoc(children, construirEncabezado(logoArrayBuffer, anioNombre), `Carpeta_${oficio}.docx`);
    }

    // =======================================================
    // ===       UTILIDADES COMPARTIDAS                    ===
    // =======================================================
    function formatearFechaLarga(f){if(!f)return"_______"; const p=f.split("-"); const m=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]; return `${parseInt(p[2])} de ${m[parseInt(p[1])-1]} de ${p[0]}`;}
    function crearParrafo(t, b, u=false) { const {Paragraph,TextRun,UnderlineType}=docx; return new Paragraph({children:[new TextRun({text:t, bold:b, underline:u?{type:UnderlineType.SINGLE}:undefined, size:24, font:"Times New Roman"})], spacing:{line:276}}); }
    function crearParrafoConSangria(t, b, u=false) { const {Paragraph,TextRun,UnderlineType}=docx; return new Paragraph({indent:{left:4000}, children:[new TextRun({text:t, bold:b, underline:u?{type:UnderlineType.SINGLE}:undefined, size:24, font:"Times New Roman"})], spacing:{line:276}}); }
    function crearParrafoJustificado(partes) { const {Paragraph,TextRun,AlignmentType}=docx; let ch=partes.map(p=>new TextRun({text:p.text, bold:p.bold, size:24, font:"Times New Roman"})); return new Paragraph({children:ch, alignment:AlignmentType.JUSTIFIED, spacing:{line:276}, indent:{firstLine:720}}); }
    function crearFilaContacto(label, val) {const { TableRow, TableCell, Paragraph, TextRun, HeightRule } = docx; return new TableRow({ height: { value: 500, rule: HeightRule.AT_LEAST }, cantSplit: true, children: [ new TableCell({ children: [new Paragraph({children:[new TextRun({text: label, bold: true, size: 20, font: "Times New Roman"})]})] }), new TableCell({ children: [new Paragraph({children:[new TextRun({text: val, size: 20, font: "Times New Roman"})]})] }) ] });}
    function crearTablaContacto(m, f, tf, ta) {const { Table, TableRow, TableCell, Paragraph, TextRun, WidthType, HeightRule } = docx;return new Table({width: { size: 90, type: WidthType.PERCENTAGE }, indent: { size: 720, type: WidthType.DXA },rows: [crearFilaContacto("CORREO ELECTR√ìNICO MESA DE PARTES", m),crearFilaContacto("CORREO ELECTR√ìNICO FISCAL ENCARGADO", f),crearFilaContacto("TEL√âFONO FISCAL", tf),crearFilaContacto("TEL√âFONO ASISTENTE", ta)]});}
    function crearVi√±eta(t,v){const {Paragraph,TextRun}=docx; return new Paragraph({bullet:{level:0},indent:{left:1440},children:[new TextRun({text:t,bold:true,size:24,font:"Times New Roman"}),new TextRun({text:v,size:24,font:"Times New Roman"})],spacing:{line:276}});}
    // =======================================================
    // ===            FUNCIONES DE ENCABEZADO              ===
    // =======================================================

    function construirEncabezado(logo, fecha, nombreAnio) {
        const {Paragraph, TextRun, Table, TableRow, TableCell, ImageRun, AlignmentType, WidthType, BorderStyle} = docx;
        
        let logoRun = logo ? new ImageRun({
            data: logo,
            transformation: { width: 110, height: 103 }
        }) : new TextRun("");

        // Limpieza de comillas dobles o curvas extras en el nombre del a√±o
        let txtAnio = nombreAnio ? `‚Äú${nombreAnio.replace(/‚Äú|‚Äù|"/g,'')}‚Äù` : "";

        return new Table({ 
            width: { size: 100, type: WidthType.PERCENTAGE }, 
            borders: {
                top: { style: BorderStyle.NONE },
                bottom: { style: BorderStyle.NONE },
                left: { style: BorderStyle.NONE },
                right: { style: BorderStyle.NONE },
                insideVertical: { style: BorderStyle.NONE },
                insideHorizontal: { style: BorderStyle.NONE }
            }, 
            rows: [
                new TableRow({
                    children: [ 
                        // CELDA IZQUIERDA: LOGO Y TEXTO MINISTERIO
                        new TableCell({
                            width: { size: 40, type: WidthType.PERCENTAGE },
                            margins: { left: -1000 }, // Mover a la izquierda
                            children: [
                                new Paragraph({ children: [logoRun], alignment: AlignmentType.CENTER }),
                                new Paragraph({ children: [new TextRun({ text: "MINISTERIO P√öBLICO", bold: false, size: 12, font: "Times New Roman" })], alignment: AlignmentType.CENTER }),
                                new Paragraph({ children: [new TextRun({ text: "PRIMERA FISCAL√çA PROVINCIAL CORPORATIVA\nESPECIALIZADA EN DELITOS DE CORRUPCI√ìN DE\nFUNCIONARIOS -SEGUNDO DESPACHO-", bold: false, size: 12, font: "Times New Roman" })], alignment: AlignmentType.CENTER })
                            ]
                        }), 
                        // CELDA DERECHA: A√ëO Y FECHA (VAC√çA SI ES JUZGADO)
                        new TableCell({
                            width: { size: 60, type: WidthType.PERCENTAGE },
                            children: [
                                new Paragraph({ children: [new TextRun({ text: txtAnio, italics: true, size: 18, font: "Times New Roman" })], alignment: AlignmentType.LEFT, spacing: { before: 800 } }),
                                new Paragraph({ text: "" }),
                                // Si pasamos fecha vac√≠a "", no se imprime nada (usado para Juzgado/Carpeta)
                                new Paragraph({ children: [new TextRun({ text: fecha, size: 24, font: "Times New Roman" })], alignment: AlignmentType.RIGHT })
                            ]
                        }) 
                    ]
                })
            ] 
        });
    }
    function crearYDescargarDoc(children, headerContent, nombre) { 
        const {Document,Packer,Footer,Paragraph,TextRun,Header}=docx; 
        const doc=new Document({
            sections:[{
                properties:{
                    page: {
                        margin: {
                            top: 1701, // 6.0 cm (Para que no pegue con el logo en p√°g 2)
                            right: 2068, // 3.6 cm
                            bottom: 1417, // 2.5 cm
                            left: 2068, // 3.6 cm
                            header: 284, // 0.5 cm
                            footer: 720 
                        }
                    }
                },
                headers: { default: new Header({ children: [headerContent] }) },
                children:children,
                footers:{default:new Footer({children:[new Paragraph({children:[new TextRun({text:"Tel√©fono: (01) 625-5555", size:20, font:"Times New Roman", color:"333333"})]}),new Paragraph({children:[new TextRun({text:"Anexos: 11706 / 11705", size:20, font:"Times New Roman", color:"333333"})]}),new Paragraph({children:[new TextRun({text:"E-mail: fecoflima_1f2d@mpfn.gob.pe", size:20, font:"Times New Roman", color:"333333"})]}),new Paragraph({children:[new TextRun({text:"Direcci√≥n: Jr. Lampa N.¬∞ 597 ‚Äì Cercado de Lima.", size:20, font:"Times New Roman", color:"333333"})]})]})}
            }]
        }); 
        Packer.toBlob(doc).then(b=>saveAs(b, nombre)); 
    }
</script>
</body>
</html>
