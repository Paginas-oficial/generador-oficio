<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Documentos - H√≠brido</title>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* ESTILOS ORIGINALES (V34) */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; padding: 40px 20px; color: #1f2937; margin: 0; }
        .menu-wrapper { max-width: 900px; margin: 0 auto; background: white; padding: 50px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; }
        .menu-title { color: #1e3a8a; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .menu-subtitle { color: #6b7280; font-size: 1.1rem; margin-bottom: 40px; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; }
        .card { border: 2px solid #e5e7eb; border-radius: 12px; padding: 30px; cursor: pointer; transition: all 0.3s ease; background: white; }
        .card:hover { border-color: #1e3a8a; transform: translateY(-5px); box-shadow: 0 10px 20px rgba(30, 58, 138, 0.1); }
        .card-icon { font-size: 40px; margin-bottom: 15px; display: block; }
        .card h3 { color: #1f2937; margin: 10px 0; font-size: 1.2rem; }
        .card p { color: #9ca3af; font-size: 0.9rem; margin: 0; }
        .app-container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none; }
        .btn-back { background-color: transparent; color: #64748b; padding: 5px 10px; border-radius: 6px; border: 1px solid #cbd5e1; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px; transition: 0.2s; }
        .btn-back:hover { background-color: #f1f5f9; color: #334155; }
        .section-title { background-color: #e0f2fe; border-left: 5px solid #1e3a8a; padding: 10px 15px; font-weight: bold; margin-top: 30px; margin-bottom: 15px; color: #1e40af; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section-content { padding: 10px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 5px 5px; margin-bottom: 20px; }
        .hidden { display: none; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-col { flex: 1; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #374151; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        textarea { height: 70px; resize: vertical; }
        .pericia-box, .delito-box, .destino-box { border: 1px dashed #2563eb; padding: 10px; margin-bottom: 10px; background: #eff6ff; border-radius: 5px; }
        .btn-generate { width: 100%; padding: 16px; background-color: #1e3a8a; color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 40px; transition: background 0.2s; }
        .btn-generate:hover { background-color: #1e40af; }
        .upload-area { background: #f0fdf4; border: 1px dashed #16a34a; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 20px; font-size: 12px; }
        #estadoImagen { font-weight: bold; margin-left: 10px; }
        .text-ok { color: #15803d; } .text-err { color: #b91c1c; }
        .time-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .preview-text { font-size: 13px; color: #059669; font-weight: bold; margin-top: 10px; font-style: italic; background: #d1fae5; padding: 5px; border-radius: 4px; display: none; }
        
        /* ESTILOS CHATBOT (V35 ADAPTADOS) */
        .chat-container { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; height: 75vh; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .chat-header { background-color: #075e54; color: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-radius: 10px 10px 0 0; }
        .avatar { width: 45px; height: 45px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; background-color: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 10px; position: relative; font-size: 15px; line-height: 1.4; }
        .bot-msg { align-self: flex-start; background: white; border-radius: 0 15px 15px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user-msg { align-self: flex-end; background: #dcf8c6; border-radius: 15px 0 15px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .input-area { background: #f0f0f0; padding: 15px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; border-radius: 0 0 10px 10px; }
        .input-field { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #fff; outline: none; font-size: 15px; }
        .send-btn { background: #075e54; color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .send-btn:hover { background: #128c7e; }
        .chat-options { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .chat-option-btn { background: #e0f2f1; color: #00695c; border: 1px solid #b2dfdb; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .chat-option-btn:hover { background: #b2dfdb; }
        .typing { font-style: italic; color: #888; font-size: 12px; margin-left: 20px; display: none; }
        
        #btn-mic { background: #1e3a8a; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        #btn-mic:hover { background: #1e40af; transform: scale(1.05); }
        .is-listening { animation: pulse 1s infinite; background: #b91c1c !important; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(185, 28, 28, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(185, 28, 28, 0); } 100% { box-shadow: 0 0 0 0 rgba(185, 28, 28, 0); } }
    </style>
</head>
<body>

    <div id="screen-menu" class="menu-wrapper">
        <h1 class="menu-title">Bienvenida, Dra.</h1>
        <p class="menu-subtitle">Elige el m√©todo de llenado:</p>
        <div class="upload-area">
            <label style="display:inline;">üìÇ Configuraci√≥n Global:</label>
            <span id="estadoImagen" class="text-err">Buscando logo.png...</span>
        </div>

        <div class="cards-grid">
            <div class="card" onclick="navegar('app-pericias')">
                <span class="card-icon">‚öñÔ∏è</span>
                <h3>Oficio de Pericias (Manual)</h3>
                <p>Llenar todos los campos del formulario tradicional.</p>
            </div>
            <div class="card" onclick="navegar('app-movilidad')">
                <span class="card-icon">üöó</span>
                <h3>Oficio de Movilidad (Manual)</h3>
                <p>Llenar todos los campos del formulario tradicional.</p>
            </div>
            <div class="card" style="background:#e0f2f1; border-color:#075e54;" onclick="navegar('app-voice-assistant')">
                <span class="card-icon">üó£Ô∏è</span>
                <h3 style="color:#075e54;">Asistente Virtual por VOZ</h3>
                <p>Chat interactivo que te gu√≠a con micr√≥fono.</p>
            </div>
        </div>
    </div>

    <div id="app-pericias" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Volver al Men√∫</button>
        <h1 style="color: #1e3a8a; text-align: center;">Oficio de Pericias (Manual)</h1>
        <p>‚ö†Ô∏è **Este formulario manual est√° incompleto en esta versi√≥n.** Usa el Asistente de Voz o el de Movilidad para probar la funcionalidad.</p>
        <div class="section-title" onclick="toggleSection('p-sec1')">1. Datos Generales ‚ñº</div>
        <div id="p-sec1" class="section-content">
             <div class="form-row"><div class="form-col"><label>N¬∞ Oficio / Carpeta (C√≥digo):</label><input type="text" id="p_codigoUnico" placeholder="Ej: 244-2023"></div><div class="form-col"><label>A√±o:</label><input type="text" id="p_anio" value="2025"></div></div>
        </div>
        <button class="btn-generate" onclick="generarWordPericiasManual()">üìÑ GENERAR OFICIO PERICIAS</button>
    </div>

    <div id="app-movilidad" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Volver al Men√∫</button>
        <h1 style="color: #1e3a8a; text-align: center;">Solicitud de Movilidad (Manual)</h1>
        <div class="section-title" onclick="toggleSection('m-sec1-manual')">1. Datos del Documento ‚ñº</div>
        <div id="m-sec1-manual" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>N¬∞ Oficio (Escribir):</label><input type="text" id="m_numOficio_manual" placeholder="Ej: 523-2025"></div>
                <div class="form-col"><label>Fecha Documento (Calendario):</label><input type="date" id="m_fechaDocumento_manual"></div>
            </div>
        </div>
        <div class="section-title" onclick="toggleSection('m-sec2-manual')">2. Destinos / Ubicaciones ‚ñº</div>
        <div id="m-sec2-manual" class="section-content">
            <label>Direcciones (separadas por punto y coma):</label>
            <textarea id="m_destinos_manual" placeholder="Ej: Corte Superior, Sede Zavala; Av. Saenz Pe√±a 116 Barranco"></textarea>
        </div>
        <div class="section-title" onclick="toggleSection('m-sec3-manual')">3. Detalle del Servicio ‚ñº</div>
        <div id="m-sec3-manual" class="section-content">
            <label>Ej: MI√âRCOLES 05 DE NOVIEMBRE DE 2025, DE 10:30 A 12:45 HORAS</label>
            <input type="text" id="m_servicio_manual" placeholder="Escribe el detalle del servicio">
        </div>
        <div class="section-title" onclick="toggleSection('m-sec4-manual')">4. Datos de Contacto ‚ñº</div>
        <div id="m-sec4-manual" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>Celular de Contacto:</label><input type="text" id="m_celular_manual" value="957691331"></div>
                <div class="form-col"><label>Nombre del Asistente:</label><input type="text" id="m_asistente_manual" value="DEBORA JASMIN SOTELO AHUANARI"></div>
            </div>
        </div>
        <button class="btn-generate" onclick="generarWordMovilidadManual()">üöó GENERAR OFICIO MOVILIDAD</button>
    </div>

    <div id="app-voice-assistant" class="app-container" style="padding: 0;">
        <div class="chat-container">
            <div class="chat-header">
                <button class="btn-back" onclick="navegar('screen-menu')" style="margin-right: 10px; background: transparent; border-color: white; color: white;">‚¨Ö</button>
                <div class="avatar">üó£Ô∏è</div>
                <div class="header-info">
                    <h2>Asistente de Voz</h2>
                    <p id="status-text">Listo para interactuar</p>
                </div>
            </div>

            <div id="chat-box" class="chat-box">
                </div>
            <div id="typing-indicator" class="typing">El asistente est√° pensando...</div>

            <div class="input-area" id="input-area">
                <div id="btn-mic" onclick="toggleListening()">
                    <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16">
                        <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                        <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3.5 8V7a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                </div>
                <input type="text" id="user-input" class="input-field" placeholder="Habla o escribe tu respuesta..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="enviarRespuesta()">Enviar</button>
            </div>
        </div>
    </div>

<script>
    // === CONFIGURACI√ìN GLOBAL ===
    const NOMBRE_ARCHIVO_IMAGEN = "logo.png"; 
    let logoArrayBuffer = null;
    let datos = {}; // Almacena las respuestas
    let pasoActual = 0;
    let flujoActual = ""; // 'PERICIAS' o 'MOVILIDAD'
    let isListening = false;

    // Configuraci√≥n de Voz (Speech Recognition)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if (recognition) {
        recognition.lang = 'es-PE'; // Espa√±ol Per√∫ (o el que mejor funcione)
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
    }

    // Configuraci√≥n de preguntas (flujo de chatbot)
    const flujos = {
        'INICIO': [
            { id: 'inicio', texto: "¬°Hola Dra.! Soy tu asistente de voz. üó£Ô∏è\n\n¬øQu√© documento vamos a redactar hoy?", tipo: 'opciones', opciones: ['Oficio de Pericias', 'Oficio de Movilidad'] }
        ],
        'MOVILIDAD': [
            { id: 'm_oficio', texto: "Perfecto, Movilidad üöó. ¬øCu√°l es el **N√∫mero de Oficio**?", tipo: 'texto', placeholder: "Ej: 523-2025" },
            { id: 'm_fecha', texto: "¬øQu√© **fecha** tendr√° el documento?", tipo: 'fecha' },
            { id: 'm_destinos', texto: "¬øA cu√°ntos **lugares** se realizar√° el traslado? (Di 'uno', 'dos' o 'tres')", tipo: 'opciones', opciones: ['1 Lugar', '2 Lugares', '3 Lugares'] },
            // Destinos se insertan aqu√≠
            { id: 'm_servicio', texto: "Dime el detalle completo del servicio.\n\n*Ej: MI√âRCOLES 05... DE 10:30 A 12:45 HORAS*", tipo: 'texto' },
            { id: 'm_celular', texto: "¬øCu√°l es el **celular de contacto**?", tipo: 'opciones_texto', opciones: ['957691331', 'Otro n√∫mero'] },
            { id: 'm_asistente', texto: "¬øQui√©n es el **Asistente Responsable**?", tipo: 'opciones_texto', opciones: ['DEBORA JASMIN SOTELO AHUANARI', 'Otro nombre'] },
            { id: 'fin_movilidad', texto: "¬°Excelente! Tengo todo. üéâ\n\nPresiona el bot√≥n para generar tu Word.", tipo: 'final' }
        ],
        'PERICIAS': [
             { id: 'p_aviso', texto: "El m√≥dulo de Pericias a√∫n no est√° enlazado a la voz üöß. \n\nPor favor usa Movilidad o el formulario manual.", tipo: 'opciones', opciones: ['Volver al inicio'] }
        ]
    };

    let preguntasActivas = [];

    // === INICIALIZACI√ìN ===
    function navegar(idPantalla) {
        document.querySelectorAll('.menu-wrapper, .app-container').forEach(el => el.style.display = 'none');
        document.getElementById(idPantalla).style.display = 'block';
        window.scrollTo(0,0);
        
        if (idPantalla === 'app-voice-assistant') {
            iniciarChatbot();
        } else {
            // Detener el micr√≥fono si salimos de la pantalla de voz
            if (recognition) recognition.stop();
        }
    }

    window.onload = function() {
        cargarLogo();
        inicializarPericias(); // Inicializa los dropdowns del formulario manual
    };

    function cargarLogo() {
        try {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', NOMBRE_ARCHIVO_IMAGEN, true);
            xhr.responseType = 'arraybuffer';
            xhr.onload = function() {
                if (xhr.status === 200) {
                    logoArrayBuffer = xhr.response;
                    document.getElementById('estadoImagen').innerText = "‚úÖ Logo cargado";
                    document.getElementById('estadoImagen').className = "text-ok";
                }
            };
            xhr.send();
        } catch(e) { console.log("Logo no cargado en local"); }
    }
    
    function toggleSection(id) { document.getElementById(id).classList.toggle('hidden'); }
    function inicializarPericias() { /* ... L√≥gica de inicializaci√≥n de formularios manuales (simplificada en este ejemplo) ... */ }


    // === CHATBOT Y CONTROL DE VOZ ===
    function iniciarChatbot() {
        // Limpiar
        document.getElementById('chat-box').innerHTML = '';
        datos = {};
        pasoActual = 0;
        flujoActual = "";
        isListening = false;
        
        // Iniciar conversaci√≥n
        agregarMensajeBot(flujos.INICIO[0]);
    }

    function toggleListening() {
        if (!recognition) {
            alert("Tu navegador no soporta el reconocimiento de voz de Google Chrome. Por favor, usa la entrada de texto o cambia de navegador.");
            return;
        }

        const micBtn = document.getElementById('btn-mic');
        if (isListening) {
            recognition.stop();
            micBtn.classList.remove('is-listening');
            isListening = false;
            document.getElementById('status-text').innerText = "Listo para interactuar";
        } else {
            try {
                recognition.start();
                micBtn.classList.add('is-listening');
                isListening = true;
                document.getElementById('status-text').innerText = "üî¥ Escuchando... Di tu respuesta.";
            } catch (e) {
                console.error(e);
                micBtn.classList.remove('is-listening');
                isListening = false;
                document.getElementById('status-text').innerText = "‚ö†Ô∏è Error al iniciar micr√≥fono";
            }
        }
    }

    if (recognition) {
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            toggleListening(); // Detener despu√©s del resultado
            document.getElementById('user-input').value = transcript;
            enviarRespuesta();
        };

        recognition.onspeechend = () => {
            // El usuario dej√≥ de hablar, pero el resultado a√∫n no se procesa
        };

        recognition.onerror = (event) => {
            if (event.error !== 'no-speech' && event.error !== 'aborted') {
                agregarMensajeBot({ texto: `‚ö†Ô∏è Error de voz: ${event.error}. Revisa tus permisos de micr√≥fono.` });
            }
            toggleListening();
        };
    }

    function agregarMensajeBot(preguntaObj) {
        const chatBox = document.getElementById('chat-box');
        const typing = document.getElementById('typing-indicator');
        typing.style.display = 'block';
        document.getElementById('input-area').style.display = 'none';

        setTimeout(() => {
            typing.style.display = 'none';
            const div = document.createElement('div');
            div.className = 'message bot-msg';
            let htmlTexto = preguntaObj.texto.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            div.innerHTML = htmlTexto;
            
            if (preguntaObj.tipo === 'opciones' || preguntaObj.tipo === 'opciones_texto') {
                const optsDiv = document.createElement('div');
                optsDiv.className = 'chat-options';
                preguntaObj.opciones.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'chat-option-btn';
                    btn.innerText = opt;
                    btn.onclick = () => procesarRespuesta(opt);
                    optsDiv.appendChild(btn);
                });
                div.appendChild(optsDiv);
            }
            if (preguntaObj.tipo === 'final') {
                const btn = document.createElement('button');
                btn.className = 'chat-option-btn';
                btn.style.backgroundColor = '#128c7e'; btn.style.color = 'white';
                btn.innerText = "üìÑ DESCARGAR WORD";
                btn.onclick = () => generarDocumentoFinal();
                div.appendChild(btn);
                const btnR = document.createElement('button');
                btnR.className = 'chat-option-btn';
                btnR.innerText = "üîÑ Empezar de nuevo";
                btnR.onclick = () => navegar('screen-menu');
                div.appendChild(btnR);
            }

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            configurarInputUsuario(preguntaObj);

        }, 600);
    }

    function configurarInputUsuario(pregunta) {
        const inputArea = document.getElementById('input-area');
        const inputField = document.getElementById('user-input');
        
        if (pregunta.tipo === 'final' || (pregunta.tipo === 'opciones' && flujoActual === 'INICIO')) { 
            inputArea.style.display = 'none';
        } else {
            inputArea.style.display = 'flex';
            inputField.value = '';
            inputField.type = pregunta.tipo === 'fecha' ? 'date' : 'text';
            inputField.placeholder = pregunta.placeholder || "Habla o escribe aqu√≠...";
            inputField.focus();
        }
    }

    function enviarRespuesta() {
        const input = document.getElementById('user-input');
        const texto = input.value.trim();
        if (!texto) return;
        procesarRespuesta(texto);
    }

    function handleKeyPress(e) {
        if (e.key === 'Enter') enviarRespuesta();
    }

    function procesarRespuesta(respuestaTexto) {
        // Mostrar mensaje del usuario
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = 'message user-msg';
        div.innerText = respuestaTexto;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;

        // L√ìGICA DE CONTROL DE FLUJO
        if (!flujoActual) {
            // Inicio: Selecciona flujo
            flujoActual = respuestaTexto.includes('Movilidad') ? 'MOVILIDAD' : 'PERICIAS';
            preguntasActivas = [...flujos[flujoActual]];
            pasoActual = 0;
            agregarMensajeBot(preguntasActivas[0]);
        } else {
            // Dentro de un flujo
            const preguntaActualObj = preguntasActivas[pasoActual];
            datos[preguntaActualObj.id] = respuestaTexto;

            // L√≥gica especial: Destinos Din√°micos
            if (preguntaActualObj.id === 'm_destinos') {
                const numLugaresStr = respuestaTexto.split(' ')[0].toLowerCase(); // "2 Lugares" -> "2"
                let numLugares = 0;
                if (numLugaresStr.includes('uno') || numLugaresStr.includes('1')) numLugares = 1;
                else if (numLugaresStr.includes('dos') || numLugaresStr.includes('2')) numLugares = 2;
                else if (numLugaresStr.includes('tres') || numLugaresStr.includes('3')) numLugares = 3;
                
                // Insertar preguntas de lugares din√°micamente
                for (let i = numLugares; i >= 1; i--) {
                    preguntasActivas.splice(pasoActual + 1, 0, {
                        id: `m_lugar_${i}`,
                        texto: `üìç Escribe o dicta la direcci√≥n del **Destino ${i}**:`,
                        tipo: 'texto',
                        placeholder: "Ej: Corte Superior, Sede Zavala..."
                    });
                }
            }

            pasoActual++;
            if (pasoActual < preguntasActivas.length) {
                agregarMensajeBot(preguntasActivas[pasoActual]);
            }
        }
    }

    // === GENERADORES DE WORD ===

    // 1. Generador para Formularios Manuales (Movilidad)
    function generarWordMovilidadManual() {
        // Mapear datos del formulario manual al objeto de datos del Chatbot
        const dataManual = {};
        dataManual['m_oficio'] = document.getElementById('m_numOficio_manual').value;
        dataManual['m_fecha'] = document.getElementById('m_fechaDocumento_manual').value;
        dataManual['m_servicio'] = document.getElementById('m_servicio_manual').value;
        dataManual['m_celular'] = document.getElementById('m_celular_manual').value;
        dataManual['m_asistente'] = document.getElementById('m_asistente_manual').value;
        // Destinos separados por ;
        const destinosRaw = document.getElementById('m_destinos_manual').value.split(';').map(s => s.trim()).filter(s => s.length > 0);
        destinosRaw.forEach((d, i) => { dataManual[`m_lugar_${i+1}`] = d; });

        generarWordMovilidad(dataManual);
    }

    // 2. Generador para Asistente de Voz/Chat
    function generarDocumentoFinal() {
        if (flujoActual === 'MOVILIDAD') {
            generarWordMovilidad(datos);
        } else {
            alert("El generador de Pericias a√∫n no est√° conectado a este modo.");
        }
    }

    // 3. Funci√≥n unificada de Generaci√≥n (usa el objeto 'datos' de la fuente)
    function generarWordMovilidad(dataFuente) {
        const { Document, Packer, Paragraph, TextRun, AlignmentType, Footer } = docx;

        const fechaDoc = formatearFechaLarga(dataFuente['m_fecha']);
        const oficio = dataFuente['m_oficio'];
        const servicio = dataFuente['m_servicio'];
        const celular = dataFuente['m_celular'];
        const asistente = dataFuente['m_asistente'];

        let destinosArr = [];
        Object.keys(dataFuente).forEach(key => {
            if (key.startsWith('m_lugar_')) destinosArr.push(dataFuente[key]);
        });
        
        let destinosTexto = destinosArr.join("; "); 
        if(destinosArr.length > 1) {
             const ultimo = destinosArr.pop();
             destinosTexto = destinosArr.join("; ") + " y " + ultimo;
        } else if (destinosArr.length > 0) {
            destinosTexto = destinosArr[0];
        }

        const children = [];
        children.push(...construirEncabezado(logoArrayBuffer, `Lima, ${fechaDoc}`));

        children.push(crearParrafo(`OFICIO N.¬∞ ${oficio}-MP-FN-2D-1¬∞FPCEDCF-LIMA.`, true, true)); 
        children.push(crearParrafo("Sr. Dr.", true));
        children.push(crearParrafo("MIRKO DINO CANO GAMERO", true));
        children.push(crearParrafo("FISCAL ADJUNTO SUPREMO TITULAR COORDINADOR NACIONAL DE LAS FISCAL√çAS ESPECIALIZADAS EN DELITOS DE CORRUPCI√ìN DE FUNCIONARIOS.", true));
        children.push(crearParrafo("PRESENTE.-", true, true)); 

        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));
        children.push(new Paragraph({ indent: { left: 4000 }, children: [new TextRun({ text: "ASUNTO: SOLICITUD DE ATENCI√ìN DE MOVILIDAD", bold: true, size: 24, font: "Arial Narrow" })], spacing: { line: 276 } }));
        children.push(new Paragraph({ text: "", spacing: { line: 276 } }));

        children.push(crearParrafoJustificado([
            "Tengo el honor de dirigirme a usted, a fin de saludarlo cordialmente, y a su vez, SOLICITAR, la asignaci√≥n de una movilidad (Veh√≠culo institucional) para nuestro despacho Fiscal, con el fin de poder trasladarnos a: ",
            {text: destinosTexto, bold: true},
            {text: "; y as√≠ dar cumplimiento con las diligencias pendientes, por lo que se solicita apoyo con car√°cter de "},
            {text: "MUY URGENTE", bold: true}, {text: ", el veh√≠culo institucional."}
        ]));

        children.push(new Paragraph({ text: "" }));

        children.push(crearParrafoJustificado([
            "En ese sentido, el 2¬∞ Despacho de la 1¬∞ Fiscal√≠a Provincial Corporativa Especializada en Delitos de Corrupci√≥n de Funcionarios de Lima Centro, cumple con ", 
            {text: "SOLICITAR", bold: true}, {text: " que nos ASIGNEN un veh√≠culo para el d√≠a "},
            {text: servicio, bold: true}, {text: "."}
        ]));

        children.push(new Paragraph({ text: "" }));

        children.push(crearParrafoJustificado([
            "Para efectos de la confirmaci√≥n de la solicitud, y de toda coordinaci√≥n, se pone de conocimiento el correo de Mesa de Partes del Despacho: ", 
            {text: "fecoflima_1f2d@mpfn.gob.pe", bold: true}, {text: "; as√≠ como el tel√©fono celular N¬∞ "},
            {text: celular, bold: true}, {text: " perteneciente a la Asistente en Funci√≥n Fiscal "},
            {text: asistente, bold: true}, {text: "."}
        ]));

        children.push(new Paragraph({ text: "" }));
        children.push(crearParrafoJustificado(["Sin otro particular, aprovecho la ocasi√≥n para expresarle las muestras de mi especial consideraci√≥n y estima personal."]));
        children.push(new Paragraph({ text: "\n\n" }));
        children.push(new Paragraph({ children: [new TextRun({ text: "Atentamente,", size: 24, font: "Arial Narrow" })], alignment: AlignmentType.CENTER }));

        const doc = new Document({
            sections: [{ 
                properties: { pageMargins: { top: 567, right: 1701, bottom: 1417, left: 1701 } }, 
                children: children,
                footers: { default: new Footer({ children: [
                    new Paragraph({ children: [new TextRun({ text: "Tel√©fono: (01) 625-5555", size: 22, font: "Arial Narrow", color: "333333" })] }),
                    new Paragraph({ children: [new TextRun({ text: "Anexos: 11706 / 11705", size: 22, font: "Arial Narrow", color: "333333" })] }),
                    new Paragraph({ children: [new TextRun({ text: "E-mail: fecoflima_1f2d@mpfn.gob.pe", size: 22, font: "Arial Narrow", color: "333333" })] }),
                    new Paragraph({ children: [new TextRun({ text: "Direcci√≥n: Jr. Lampa N.¬∞ 597 ‚Äì Cercado de Lima.", size: 22, font: "Arial Narrow", color: "333333" })] })
                ]})}
            }]
        });

        Packer.toBlob(doc).then(blob => { saveAs(blob, `Oficio_Movilidad_${oficio}.docx`); });
    }

    // === HELPERS (Mismos de V35/V34) ===
    function formatearFechaLarga(fechaStr) {
        if (!fechaStr || !fechaStr.includes('-')) return fechaStr;
        const partes = fechaStr.split("-");
        const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        return `${parseInt(partes[2])} de ${meses[parseInt(partes[1])-1]} de ${partes[0]}`;
    }
    function construirEncabezado(logo, fecha) {
        const { Paragraph, TextRun, Table, TableRow, TableCell, ImageRun, AlignmentType, WidthType, BorderStyle } = docx;
        let logoRun = logo ? new ImageRun({ data: logo, transformation: { width: 140, height: 133 } }) : new TextRun("");
        return [
            new Table({
                width: { size: 100, type: WidthType.PERCENTAGE }, borders: { top: {style: BorderStyle.NONE}, bottom: {style: BorderStyle.NONE}, left: {style: BorderStyle.NONE}, right: {style: BorderStyle.NONE}, insideVertical: {style: BorderStyle.NONE}, insideHorizontal: {style: BorderStyle.NONE} },
                rows: [ new TableRow({ children: [ new TableCell({ width: { size: 40, type: WidthType.PERCENTAGE }, margins: { left: -1000 }, children: [ new Paragraph({ children: [logoRun], alignment: AlignmentType.CENTER }), new Paragraph({ children: [new TextRun({ text: "MINISTERIO P√öBLICO", bold: false, size: 14, font: "Arial Narrow" })], alignment: AlignmentType.CENTER }), new Paragraph({ children: [new TextRun({ text: "PRIMERA FISCAL√çA PROVINCIAL CORPORATIVA\nESPECIALIZADA EN DELITOS DE CORRUPCI√ìN DE\nFUNCIONARIOS -SEGUNDO DESPACHO-", bold: false, size: 14, font: "Arial Narrow" })], alignment: AlignmentType.CENTER }) ]}), new TableCell({ width: { size: 60, type: WidthType.PERCENTAGE }, children: [ new Paragraph({ children: [new TextRun({ text: "‚ÄúA√±o de la recuperaci√≥n y consolidaci√≥n de la econom√≠a peruana‚Äù", italics: true, size: 18, font: "Arial Narrow" })], alignment: AlignmentType.RIGHT, spacing: { before: 800 } }), new Paragraph({ text: "" }), new Paragraph({ children: [new TextRun({ text: fecha, size: 24, font: "Arial Narrow" })], alignment: AlignmentType.RIGHT }) ]}) ]}) ]}), new Paragraph({ text: "" }) ];
    }
    function crearParrafo(texto, negrita=false, subrayado=false) {
        const { Paragraph, TextRun } = docx;
        return new Paragraph({ children: [new TextRun({ text: texto, bold: negrita, size: 24, font: "Arial Narrow" })], spacing: { line: 276 } });
    }
    function crearParrafoJustificado(partes, sangriaPrimeraLinea=false) {
        const { Paragraph, TextRun, AlignmentType } = docx;
        let children = partes.map(p => {
            if(typeof p === 'string') return new TextRun({ text: p, size: 24, font: "Arial Narrow" });
            return new TextRun({ text: p.text, bold: p.bold, size: 24, font: "Arial Narrow" });
        });
        return new Paragraph({ children: children, alignment: AlignmentType.JUSTIFIED, spacing: { line: 276 }, indent: sangriaPrimeraLinea ? { firstLine: 720 } : undefined });
    }
</script>
</body>
</html>
