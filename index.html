<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Fiscal 2026 - Integrado</title>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; padding: 40px 20px; color: #1f2937; margin: 0; }
        
        /* MENU STYLE */
        .menu-wrapper { max-width: 1000px; margin: 0 auto; background: white; padding: 50px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; }
        .menu-title { color: #1e3a8a; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .menu-subtitle { color: #6b7280; font-size: 1.1rem; margin-bottom: 40px; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .card { border: 2px solid #e5e7eb; border-radius: 12px; padding: 30px 20px; cursor: pointer; transition: all 0.3s ease; background: white; }
        .card:hover { border-color: #1e3a8a; transform: translateY(-5px); box-shadow: 0 10px 20px rgba(30, 58, 138, 0.1); }
        .card-icon { font-size: 40px; margin-bottom: 15px; display: block; }
        .card h3 { color: #1f2937; margin: 10px 0; font-size: 1.1rem; font-weight: 700; }
        .card p { color: #9ca3af; font-size: 0.85rem; margin: 0; }

        /* APP CONTAINERS */
        .app-container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none; }
        .btn-back { background-color: transparent; color: #64748b; padding: 5px 10px; border-radius: 6px; border: 1px solid #cbd5e1; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px; transition: 0.2s; }
        .btn-back:hover { background-color: #f1f5f9; color: #334155; }
        
        /* FORMULARIOS */
        .section-title { background-color: #e0f2fe; border-left: 5px solid #1e3a8a; padding: 10px 15px; font-weight: bold; margin-top: 30px; margin-bottom: 15px; color: #1e40af; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section-content { display: block; padding: 10px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 5px 5px; margin-bottom: 20px; }
        .hidden { display: none; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-col { flex: 1; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #374151; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        textarea { height: 70px; resize: vertical; }
        
        .btn-generate { width: 100%; padding: 16px; background-color: #1e3a8a; color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 40px; transition: background 0.2s; }
        .btn-generate:hover { background-color: #1e40af; }
        .upload-area { background: #f0fdf4; border: 1px dashed #16a34a; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 20px; font-size: 12px; }
        #estadoImagen { font-weight: bold; margin-left: 10px; }
        .text-ok { color: #15803d; } .text-err { color: #b91c1c; }
        
        /* Estilos espec√≠ficos para Referencias y Checkboxes */
        .ref-box { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .ref-label { font-weight: bold; color: #1e3a8a; width: 30px; }
        .btn-small { background: #e0f2fe; color: #1e40af; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px; font-weight: bold; }
        .check-group { display: flex; gap: 20px; margin-top: 10px; background: white; padding: 10px; border-radius: 5px; border: 1px solid #e5e7eb; }
        .check-item { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; }
        .check-item input { width: auto; margin: 0; cursor: pointer; }

        /* Estilos Chatbot Voz */
        .chat-container { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; height: 80vh; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        .chat-header { background-color: #075e54; color: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; }
        .avatar-container { position: relative; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; }
        .avatar { width: 45px; height: 45px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 2; position: relative; }
        .voice-wave { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: rgba(255,255,255,0.3); z-index: 1; opacity: 0; }
        .is-speaking .voice-wave { animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.5); opacity: 0; } }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; background-color: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .message { max-width: 80%; padding: 12px 18px; border-radius: 10px; position: relative; font-size: 16px; line-height: 1.5; }
        .bot-msg { align-self: flex-start; background: white; border-radius: 0 15px 15px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user-msg { align-self: flex-end; background: #dcf8c6; border-radius: 15px 0 15px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .input-area { background: #f0f0f0; padding: 15px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; }
        .input-field { flex: 1; padding: 15px; border-radius: 30px; border: 1px solid #fff; outline: none; font-size: 16px; }
        .send-btn { background: #075e54; color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .chat-options { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .chat-option-btn { background: #e0f2f1; color: #00695c; border: 1px solid #b2dfdb; padding: 10px 18px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: 0.2s; }
        #btn-mic { background: #128c7e; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .is-listening { animation: pulse-red 1.5s infinite; background: #dc2626 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        .typing { font-style: italic; color: #888; font-size: 12px; margin-left: 20px; display: none; }
        .audio-control { cursor: pointer; font-size: 20px; margin-right: 15px; }
    </style>
</head>
<body>

    <div id="screen-menu" class="menu-wrapper">
        <h1 class="menu-title">Bienvenida, Dra.</h1>
        <p class="menu-subtitle">Sistema de Gesti√≥n Fiscal 2026</p>
        <div class="upload-area"><label>üìÇ Configuraci√≥n:</label><span id="estadoImagen" class="text-err">Buscando logo.png...</span></div>

        <div class="cards-grid">
            <div class="card" onclick="navegar('app-pericias')">
                <span class="card-icon">‚öñÔ∏è</span>
                <h3>Oficio de Pericias</h3>
                <p>Solicitud de peritos contables, etc.</p>
            </div>
            <div class="card" onclick="navegar('app-movilidad')">
                <span class="card-icon">üöó</span>
                <h3>Oficio de Movilidad</h3>
                <p>Solicitud de veh√≠culo institucional.</p>
            </div>
            <div class="card" onclick="navegar('app-atencion')">
                <span class="card-icon">üì®</span>
                <h3>Atenci√≥n de Pedidos</h3>
                <p>Respuesta a solicitudes de informaci√≥n.</p>
            </div>
            <div class="card" style="background:#e0f2f1; border-color:#075e54;" onclick="navegar('app-voice-assistant')">
                <span class="card-icon">üó£Ô∏è</span>
                <h3 style="color:#075e54;">Asistente de Voz IA</h3>
                <p>Conversaci√≥n interactiva.</p>
            </div>
        </div>
    </div>

    <div id="app-pericias" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Men√∫ Principal</button>
        <h1 style="color: #1e3a8a; text-align: center;">Oficio de Pericias</h1>
        
        <div class="section-title" onclick="toggleSection('p-sec1')">1. Datos Generales ‚ñº</div>
        <div id="p-sec1" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>N¬∞ Oficio / Carpeta:</label><input type="text" id="p_codigoUnico" placeholder="Ej: 244-2026"></div>
                <div class="form-col"><label>A√±o:</label><input type="text" id="p_anio" value="2026"></div>
            </div>
            <div class="form-row"><div class="form-col"><label>Nombre del A√±o (Opcional):</label><input type="text" id="p_nombreAnio" placeholder="Ej: A√±o de la consolidaci√≥n... (Dejar vac√≠o si no hay)"></div></div>
            
            <div class="form-row">
                <div class="form-col"><label>D√≠a:</label><select id="p_dia"></select></div>
                <div class="form-col"><label>Mes:</label><select id="p_mes"></select></div>
            </div>
        </div>

        <div class="section-title" onclick="toggleSection('p-sec2')">2. Cuerpo Principal ‚ñº</div>
        <div id="p-sec2" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>N¬∞ Disposici√≥n:</label><select id="p_numDisposicion"></select></div>
                <div class="form-col"><label>Fecha Disp.:</label><input type="date" id="p_fechaDisposicion"></div>
            </div>
            <div class="form-row"><div class="form-col"><label>Decisi√≥n:</label><select id="p_decision"><option>La AMPLIACI√ìN SUPLEMENTARIA DE LA INVESTIGACI√ìN PREPARATORIA</option><option>INICIO DE DILIGENCIAS PRELIMINARES</option><option>FORMALIZACI√ìN DE LA INVESTIGACI√ìN PREPARATORIA</option></select></div></div>
            <div class="form-row"><div class="form-col"><label>Imputados:</label><input type="text" id="p_imputados"></div></div>
            <div class="form-row" style="background: #f9fafb; padding: 10px;"><div class="form-col"><label>Cant. Delitos:</label><select id="p_cantDelitos" onchange="generarDelitosPericias()"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div><div class="form-col"><div id="p_contenedorDelitos"></div></div></div>
            <div class="form-row"><div class="form-col"><label>Plazo:</label><select id="p_plazoActuaciones"></select></div></div>
        </div>

        <div class="section-title" onclick="toggleSection('p-sec3')">3. Datos T√©cnicos ‚ñº</div>
        <div id="p-sec3" class="section-content">
            <div class="form-row"><div class="form-col"><label>Etapa:</label><select id="p_etapaProcesal"><option>Investigaci√≥n Preparatoria</option><option>Diligencias Preliminares</option></select></div><div class="form-col"><label>Vencimiento:</label><input type="date" id="p_plazoVencimiento"></div></div>
            <div class="form-row"><div class="form-col"><label>Involucrados:</label><select id="p_cantInvolucrados"></select></div><div class="form-col"><label>Disp. Ordena:</label><input type="text" id="p_dispoOrdena"></div></div>
        </div>

        <div class="section-title" onclick="toggleSection('p-sec4')">4. Pericias ‚ñº</div>
        <div id="p-sec4" class="section-content">
            <label>Cantidad:</label><select id="p_cantPericias" onchange="generarCamposPericias()"><option value="0">--</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
            <div id="p_contenedorPericias"></div>
        </div>

        <div class="section-title" onclick="toggleSection('p-sec5')">5. Evidencia ‚ñº</div>
        <div id="p-sec5" class="section-content">
            <label>¬øAdjuntar?</label><select id="p_tieneEvidencia" onchange="toggleEvidencia()"><option value="no">No</option><option value="si">S√≠</option></select>
            <div id="p_boxEvidencia" class="hidden" style="margin-top:10px;"><label>Descripci√≥n:</label><textarea id="p_descEvidencia"></textarea><label>Link:</label><input type="text" id="p_linkEvidencia"></div>
        </div>

        <div class="section-title" onclick="toggleSection('p-sec6')">6. Contacto ‚ñº</div>
        <div id="p-sec6" class="section-content">
            <div class="form-row"><div class="form-col"><label>Mesa Partes:</label><input type="text" id="p_emailMesa" value="fecoflima_1f2d@mpfn.gob.pe"></div><div class="form-col"><label>Fiscal:</label><input type="text" id="p_emailFiscal" value="ncordova@mpfn.gob.pe"></div></div>
            <div class="form-row"><div class="form-col"><label>Tel. Fiscal:</label><input type="text" id="p_telFiscal" value="945 112 224"></div><div class="form-col"><label>Tel. Asistente:</label><input type="text" id="p_telAsistente" value="957 691 331"></div></div>
        </div>

        <button class="btn-generate" onclick="generarWordPericias()">üìÑ GENERAR OFICIO PERICIAS</button>
    </div>

    <div id="app-movilidad" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Men√∫ Principal</button>
        <h1 style="color: #1e3a8a; text-align: center;">Solicitud de Movilidad</h1>

        <div class="section-title" onclick="toggleSection('m-sec1')">1. Datos del Documento ‚ñº</div>
        <div id="m-sec1" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>N¬∞ Oficio:</label><input type="text" id="m_numOficio" placeholder="Ej: 523-2026"></div>
                <div class="form-col"><label>Fecha:</label><input type="date" id="m_fechaDocumento"></div>
            </div>
            <div class="form-row"><div class="form-col"><label>Nombre del A√±o (Opcional):</label><input type="text" id="m_nombreAnio" placeholder="Ej: A√±o de la consolidaci√≥n... (Dejar vac√≠o si no hay)"></div></div>
        </div>

        <div class="section-title" onclick="toggleSection('m-sec2')">2. Destinos ‚ñº</div>
        <div id="m-sec2" class="section-content">
            <label>Cantidad:</label><select id="m_cantDestinos" onchange="generarCamposDestinos()"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
            <div id="m_contenedorDestinos"></div>
        </div>

        <div class="section-title" onclick="toggleSection('m-sec3')">3. Servicio ‚ñº</div>
        <div id="m-sec3" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>D√≠a:</label><input type="date" id="m_diaServicio" onchange="actualizarPreviewServicio()"></div>
                <div class="form-col"><label>Inicio:</label><input type="time" id="m_horaInicio" onchange="actualizarPreviewServicio()"></div>
                <div class="form-col"><label>Fin:</label><input type="time" id="m_horaFin" onchange="actualizarPreviewServicio()"></div>
            </div>
            <div id="m_previewServicio" class="preview-text">Selecciona fecha y horas...</div>
        </div>

        <div class="section-title" onclick="toggleSection('m-sec4')">4. Contacto ‚ñº</div>
        <div id="m-sec4" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>Celular:</label><select id="m_comboCelular" onchange="toggleManual('m_comboCelular','m_celularManual')"><option value="957691331">957691331 (D√©bora)</option><option value="OTRO">Otro...</option></select><input type="text" id="m_celularManual" style="display:none;"></div>
                <div class="form-col"><label>Asistente:</label><select id="m_comboAsistente" onchange="toggleManual('m_comboAsistente','m_asistenteManual')"><option value="DEBORA JASMIN SOTELO AHUANARI">DEBORA JASMIN SOTELO AHUANARI</option><option value="OTRO">Otro...</option></select><input type="text" id="m_asistenteManual" style="display:none;"></div>
            </div>
        </div>
        <button class="btn-generate" onclick="generarWordMovilidad()">üöó GENERAR OFICIO MOVILIDAD</button>
    </div>

    <div id="app-atencion" class="app-container">
        <button class="btn-back" onclick="navegar('screen-menu')">‚¨Ö Men√∫ Principal</button>
        <h1 style="color: #1e3a8a; text-align: center;">Atenci√≥n de Pedidos</h1>

        <div class="section-title" onclick="toggleSection('a-sec1')">1. Datos Generales ‚ñº</div>
        <div id="a-sec1" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>N¬∞ Oficio Respuesta:</label><input type="text" id="a_oficio" placeholder="Ej: 50-2026-MP-FN..."></div>
                <div class="form-col"><label>Fecha Emisi√≥n:</label><input type="date" id="a_fecha"></div>
            </div>
            <div class="form-row">
                <div class="form-col"><label>Nombre del A√±o (Opcional):</label><input type="text" id="a_nombreAnio" placeholder="Ej: A√±o de la consolidaci√≥n... (Dejar vac√≠o si no hay)"></div>
            </div>
        </div>

        <div class="section-title" onclick="toggleSection('a-sec2')">2. Destinatario ‚ñº</div>
        <div id="a-sec2" class="section-content">
            <div class="form-row">
                <div class="form-col"><label>Nombre Completo:</label><input type="text" id="a_dest_nombre" placeholder="Ej: JUAN PEREZ..."></div>
                <div class="form-col"><label>Cargo:</label><input type="text" id="a_dest_cargo" placeholder="Ej: FISCAL PROVINCIAL..."></div>
            </div>
        </div>

        <div class="section-title" onclick="toggleSection('a-sec3')">3. Referencias (Oficios recibidos) ‚ñº</div>
        <div id="a-sec3" class="section-content">
            <div id="container-referencias"></div>
            <button class="btn-small" onclick="agregarReferencia()">+ Agregar Referencia</button>
        </div>

        <div class="section-title" onclick="toggleSection('a-sec4')">4. Cuerpo y Respuesta ‚ñº</div>
        <div id="a-sec4" class="section-content">
            <label>Protocolo de Saludo:</label>
            <select id="a_saludo" style="margin-bottom:15px;">
                <option value="Es grato dirigirme a usted">Es grato dirigirme a usted</option>
                <option value="Es un honor dirigirme a usted">Es un honor dirigirme a usted</option>
            </select>

            <div style="background:#eff6ff; padding:15px; border-radius:8px; border:1px dashed #1e3a8a;">
                <label style="color:#1e3a8a;">¬øEl despacho cuenta con la informaci√≥n?</label>
                <select id="a_tieneInfo" onchange="toggleInfoDespacho()" style="font-weight:bold;">
                    <option value="NO">NO CUENTA (Respuesta Negativa)</option>
                    <option value="SI">S√ç CUENTA (Respuesta Positiva)</option>
                </select>

                <div id="panel-info-si" style="display:none; margin-top:15px; border-top:1px solid #ccc; padding-top:10px;">
                    <label>Carpetas Fiscales encontradas:</label>
                    <input type="text" id="a_carpetas" placeholder="Ej: N.¬∞ 50-2024 y N.¬∞ 170-2022">
                    <label style="margin-top:10px;">Se adjunta:</label>
                    <div class="check-group">
                        <div class="check-item"><input type="checkbox" id="chk_dispo"> Disposiciones Fiscales</div>
                        <div class="check-item"><input type="checkbox" id="chk_declara"> Declaraciones</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn-generate" onclick="generarWordAtencion()">üìÑ GENERAR OFICIO ATENCI√ìN</button>
    </div>

    <div id="app-voice-assistant" class="app-container" style="padding: 0;">
        <div class="chat-container">
            <div class="chat-header">
                <button class="btn-back" onclick="navegar('screen-menu')" style="margin-right: 10px; background: transparent; border-color: rgba(255,255,255,0.5); color: white; margin-bottom:0;">‚¨Ö Salir</button>
                <div class="avatar-container" id="avatar-anim"><div class="voice-wave"></div><div class="avatar">üë©‚Äç‚öñÔ∏è</div></div>
                <div class="header-info"><h2 style="margin:0; font-size:18px;">Asistente Fiscal</h2><p id="status-text" style="margin:0; font-size:12px; opacity:0.9;">En l√≠nea</p></div>
                <div style="margin-left: auto;"><span id="btn-audio-toggle" class="audio-control" onclick="toggleAudio()">üîä</span></div>
            </div>
            <div id="chat-box" class="chat-box"></div>
            <div id="typing-indicator" class="typing">Escribiendo...</div>
            <div class="input-area" id="input-area">
                <div id="btn-mic" onclick="clickMicManual()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3.5 8V7a.5.5 0 0 1 .5-.5z"/></svg></div>
                <input type="text" id="user-input" class="input-field" placeholder="Escribe o habla..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="enviarRespuesta()">Enviar</button>
            </div>
        </div>
    </div>

<script>
    // === CONFIGURACI√ìN GLOBAL ===
    const NOMBRE_ARCHIVO_IMAGEN = "logo.png"; 
    let logoArrayBuffer = null;
    let audioEnabled = true;

    // Listas Globales
    const listaOpcionesDelito = ["Colusi√≥n Simple", "Colusi√≥n Agravada", "Negociaci√≥n Incompatible", "Peculado", "Peculado Doloso", "Peculado Culposo", "Tr√°fico de Influencias", "Concusi√≥n", "Cohecho", "Cohecho Pasivo", "Cohecho Activo", "Cohecho Pasivo Propio", "Cohecho Pasivo Impropio", "Usurpaci√≥n de Funciones"];
    const listaPlazos = ["treinta (30) d√≠as naturales", "sesenta (60) d√≠as naturales", "noventa (90) d√≠as naturales", "ciento veinte (120) d√≠as naturales", "ciento cincuenta (150) d√≠as naturales", "ciento ochenta (180) d√≠as naturales"];
    const listaLugares = ["Corte Superior de Lima, Sede Zavala, ubicado en Jir√≥n Manuel Cuadros 182, Lima", "DIRCOCOR PNP, ubicado en Av. Saenz Pe√±a 116 Barranco, Lima", "Sede Central del Ministerio P√∫blico, ubicado en Av. Abancay cuadra 5 S/N"];

    // === INICIO ===
    window.onload = function() {
        try { const xhr=new XMLHttpRequest(); xhr.open('GET',NOMBRE_ARCHIVO_IMAGEN,true); xhr.responseType='arraybuffer'; xhr.onload=function(){if(xhr.status===200)logoArrayBuffer=xhr.response;}; xhr.send(); }catch(e){}
        inicializarPericias();
        inicializarMovilidad();
        agregarReferencia(); // Inicializar Atenci√≥n
    };

    function navegar(id) {
        document.querySelectorAll('.menu-wrapper, .app-container').forEach(e => e.style.display='none');
        document.getElementById(id).style.display='block';
        window.scrollTo(0,0);
        if(id==='app-voice-assistant') iniciarChatbot(); else detenerTodoAudio();
    }
    function toggleSection(id){ document.getElementById(id).classList.toggle('hidden'); }

    // === PERICIAS ===
    function inicializarPericias() {
        const selMes=document.getElementById('p_mes'); ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"].forEach(m=>{let o=document.createElement('option');o.text=m;selMes.add(o);});
        const selDia=document.getElementById('p_dia'); for(let i=1;i<=31;i++){let o=document.createElement('option');o.text=i;selDia.add(o);}
        const selDisp=document.getElementById('p_numDisposicion'); for(let i=1;i<=100;i++){let o=document.createElement('option');o.text=i.toString().padStart(2,'0');selDisp.add(o);}
        const selInv=document.getElementById('p_cantInvolucrados'); for(let i=1;i<=50;i++){let o=document.createElement('option');o.text=i;selInv.add(o);}
        const selPlazo=document.getElementById('p_plazoActuaciones'); listaPlazos.forEach(p=>{let o=document.createElement('option');o.text=p;selPlazo.add(o);});
        generarDelitosPericias();
    }
    function generarDelitosPericias(){ const c=document.getElementById('p_cantDelitos').value; const d=document.getElementById('p_contenedorDelitos'); d.innerHTML=""; for(let i=0;i<c;i++){let s=document.createElement('select'); s.id=`p_delito_${i}`; s.style.width="100%"; listaOpcionesDelito.forEach(o=>{let opt=document.createElement('option');opt.text=o;s.add(opt);}); d.appendChild(s);}}
    function generarCamposPericias(){ const c=document.getElementById('p_cantPericias').value; const d=document.getElementById('p_contenedorPericias'); d.innerHTML=""; for(let i=1;i<=c;i++){ d.innerHTML+=`<div class="pericia-box"><label>Objeto ${i}:</label><select id="p_tipoPericia_${i}"><option>Perito Contable</option><option>Perito Econ√≥mico</option><option>Perito Forense</option><option>Perito Grafot√©cnico</option></select><textarea id="p_objPericia_${i}" placeholder="Objeto..."></textarea><textarea id="p_detPericia_${i}" placeholder="Detalle..."></textarea></div>`;}}
    function toggleEvidencia(){document.getElementById('p_boxEvidencia').classList.toggle('hidden', document.getElementById('p_tieneEvidencia').value!=='si');}

    // === MOVILIDAD ===
    function inicializarMovilidad() { generarCamposDestinos(); }
    function generarCamposDestinos(){ const c=document.getElementById('m_cantDestinos').value; const d=document.getElementById('m_contenedorDestinos'); d.innerHTML=""; for(let i=1;i<=c;i++){ d.innerHTML+=`<div class="destino-box"><label>Destino ${i}:</label><select id="m_tipoDestino_${i}" onchange="toggleDestinoManual(${i})"><option value="">--Seleccionar--</option>${listaLugares.map(l=>`<option>${l}</option>`).join('')}<option value="OTRO">OTRO</option></select><input type="text" id="m_destinoManual_${i}" style="display:none;"></div>`;}}
    function toggleDestinoManual(i){ const v=document.getElementById(`m_tipoDestino_${i}`).value; document.getElementById(`m_destinoManual_${i}`).style.display=(v==='OTRO')?'block':'none'; }
    function toggleManual(c,i){ const v=document.getElementById(c).value; document.getElementById(i).style.display=(v==='OTRO')?'block':'none'; }
    function actualizarPreviewServicio(){ const f=document.getElementById('m_diaServicio').value; const i=document.getElementById('m_horaInicio').value; const fn=document.getElementById('m_horaFin').value; if(f&&i&&fn){ const d=new Date(f+'T00:00:00'); const ft=d.toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).toUpperCase(); document.getElementById('m_previewServicio').innerText=`${ft}, DE ${i} A ${fn} HORAS`; document.getElementById('m_previewServicio').style.display='block';}}

    // === ATENCI√ìN PEDIDOS ===
    let refCount = 0; const letras = ['a)', 'b)', 'c)', 'd)', 'e)'];
    function agregarReferencia() { if(refCount>=5)return; const c=document.getElementById('container-referencias'); const d=document.createElement('div'); d.className='ref-box'; d.id=`ref-row-${refCount}`; d.innerHTML=`<span class="ref-label">${letras[refCount]}</span><input type="text" id="ref_input_${refCount}" placeholder="Ref...">`; c.appendChild(d); refCount++; }
    function toggleInfoDespacho() { document.getElementById('panel-info-si').style.display=(document.getElementById('a_tieneInfo').value==='SI')?'block':'none'; }

    // === ASISTENTE VOZ ===
    const synth=window.speechSynthesis; const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition; const recognition=SpeechRecognition?new SpeechRecognition():null; if(recognition){recognition.lang='es-PE'; recognition.interimResults=false;}
    let datos={}, pasoActual=0, flujoActual="", preguntasActivas=[], isListening=false, silenceTimer=null;
    const flujos = {
        'INICIO': [{id:'ini',texto:"Hola Dra. Soy su asistente. ¬øQu√© redactamos?",tipo:'opciones',opciones:['Oficio de Movilidad','Oficio de Pericias']}],
        'MOVILIDAD': [{id:'m_oficio',texto:"D√≠game el N√∫mero de Oficio.",tipo:'texto'},{id:'m_fecha',texto:"¬øQu√© fecha tiene?",tipo:'fecha'},{id:'m_destinos',texto:"¬øCu√°ntos lugares? ¬øUno, dos o tres?",tipo:'opciones',opciones:['1 Lugar','2 Lugares']},{id:'m_servicio',texto:"Detalle fecha y hora del servicio.",tipo:'texto'},{id:'m_celular',texto:"¬øCelular?",tipo:'opciones_texto',opciones:['957691331']},{id:'m_asistente',texto:"¬øAsistente?",tipo:'opciones_texto',opciones:['DEBORA JASMIN SOTELO AHUANARI']},{id:'fin',texto:"Listo. Generando.",tipo:'final'}]
    };
    function iniciarChatbot(){ document.getElementById('chat-box').innerHTML=''; datos={}; pasoActual=0; flujoActual=""; setTimeout(()=>agregarMensajeBot(flujos.INICIO[0]),800); }
    function agregarMensajeBot(p){ 
        const box=document.getElementById('chat-box'); document.getElementById('typing-indicator').style.display='none'; document.getElementById('input-area').style.display='none';
        const d=document.createElement('div'); d.className='message bot-msg'; d.innerHTML=p.texto; 
        if(p.tipo==='opciones'||p.tipo==='opciones_texto'){ const o=document.createElement('div'); o.className='chat-options'; p.opciones.forEach(opt=>{const b=document.createElement('button');b.className='chat-option-btn';b.innerText=opt;b.onclick=()=>procesarRespuesta(opt);o.appendChild(b);}); d.appendChild(o); }
        if(p.tipo==='final'){ const b=document.createElement('button'); b.className='chat-option-btn'; b.innerText="üìÑ DESCARGAR"; b.onclick=()=>generarWordMovilidadChat(); d.appendChild(b); }
        box.appendChild(d); box.scrollTop=box.scrollHeight;
        hablar(p.texto, ()=>{ if(p.tipo!=='final'){ configurarInput(p); activarEscuchaAutomatica(); } });
    }
    function configurarInput(p){ const f=document.getElementById('user-input'); document.getElementById('input-area').style.display='flex'; f.value=''; f.type=p.tipo==='fecha'?'date':'text'; f.focus(); }
    function hablar(t,cb){ if(!audioEnabled){if(cb)cb();return;} synth.cancel(); const u=new SpeechSynthesisUtterance(t.replace(/\*/g,'')); u.lang='es-ES'; u.rate=1.1; u.onstart=()=>document.getElementById('avatar-anim').classList.add('is-speaking'); u.onend=()=>{document.getElementById('avatar-anim').classList.remove('is-speaking');if(cb)cb();}; synth.speak(u); }
    function activarEscuchaAutomatica(){ if(!recognition)return; try{recognition.start(); isListening=true; document.getElementById('btn-mic').classList.add('is-listening'); clearTimeout(silenceTimer); silenceTimer=setTimeout(()=>{if(isListening)detenerEscucha();},10000);}catch(e){} }
    function detenerEscucha(){ if(recognition)recognition.stop(); isListening=false; document.getElementById('btn-mic').classList.remove('is-listening'); clearTimeout(silenceTimer); }
    if(recognition){ recognition.onresult=(e)=>{clearTimeout(silenceTimer); detenerEscucha(); document.getElementById('user-input').value=e.results[0][0].transcript; setTimeout(enviarRespuesta,800);}; recognition.onerror=()=>detenerEscucha(); }
    function procesarRespuesta(t){ 
        const box=document.getElementById('chat-box'); const d=document.createElement('div'); d.className='message user-msg'; d.innerText=t; box.appendChild(d); box.scrollTop=box.scrollHeight;
        if(!flujoActual){ if(t.toLowerCase().includes('movilidad')){flujoActual='MOVILIDAD'; preguntasActivas=[...flujos.MOVILIDAD]; pasoActual=0; agregarMensajeBot(preguntasActivas[0]);}else{agregarMensajeBot({texto:"Solo Movilidad disponible por ahora."});} }
        else { datos[preguntasActivas[pasoActual].id]=t; if(preguntasActivas[pasoActual].id==='m_destinos'){ /* L√≥gica simple destinos */ } pasoActual++; if(pasoActual<preguntasActivas.length) agregarMensajeBot(preguntasActivas[pasoActual]); }
    }
    function enviarRespuesta(){ const v=document.getElementById('user-input').value; if(v)procesarRespuesta(v); }
    function clickMicManual(){ if(isListening)detenerEscucha(); else activarEscuchaAutomatica(); }
    function toggleAudio(){ audioEnabled=!audioEnabled; if(!audioEnabled)detenerTodoAudio(); }
    function detenerTodoAudio(){ synth.cancel(); detenerEscucha(); }
    function handleKeyPress(e){if(e.key==='Enter')enviarRespuesta();}

    // === GENERADORES ===
    function formatearFechaLarga(f){ if(!f)return"_______"; if(!f.includes('-'))return f; const p=f.split("-"); const m=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]; return `${parseInt(p[2])} de ${m[parseInt(p[1])-1]} de ${p[0]}`; }
    function construirEncabezado(logo, fecha, nombreAnio) {
        const {Paragraph,TextRun,Table,TableRow,TableCell,ImageRun,AlignmentType,WidthType,BorderStyle}=docx;
        let logoRun=logo?new ImageRun({data:logo,transformation:{width:140,height:133}}):new TextRun("");
        let txtAnio=nombreAnio?`‚Äú${nombreAnio.replace(/‚Äú|‚Äù|"/g,'')}‚Äù`:"";
        return [ new Table({ width:{size:100,type:WidthType.PERCENTAGE}, borders:{top:{style:BorderStyle.NONE},bottom:{style:BorderStyle.NONE},left:{style:BorderStyle.NONE},right:{style:BorderStyle.NONE},insideVertical:{style:BorderStyle.NONE},insideHorizontal:{style:BorderStyle.NONE}}, rows:[ new TableRow({ children:[ new TableCell({width:{size:40,type:WidthType.PERCENTAGE},margins:{left:-1000},children:[new Paragraph({children:[logoRun],alignment:AlignmentType.CENTER}),new Paragraph({children:[new TextRun({text:"MINISTERIO P√öBLICO",bold:false,size:20,font:"Arial Narrow"})],alignment:AlignmentType.CENTER}),new Paragraph({children:[new TextRun({text:"PRIMERA FISCAL√çA PROVINCIAL CORPORATIVA\nESPECIALIZADA EN DELITOS DE CORRUPCI√ìN DE\nFUNCIONARIOS -SEGUNDO DESPACHO-",bold:false,size:20,font:"Arial Narrow"})],alignment:AlignmentType.CENTER})]}) , new TableCell({width:{size:60,type:WidthType.PERCENTAGE},children:[new Paragraph({children:[new TextRun({text:txtAnio,italics:true,size:18,font:"Arial Narrow"})],alignment:AlignmentType.LEFT,spacing:{before:800}}),new Paragraph({text:""}),new Paragraph({children:[new TextRun({text:fecha,size:24,font:"Arial Narrow"})],alignment:AlignmentType.RIGHT})]}) ] }) ] }), new Paragraph({text:""}) ];
    }
    
    // Generar Pericias
    function generarWordPericias() {
        const {Document,Packer,Paragraph,TextRun,AlignmentType,UnderlineType}=docx;
        const codigo=document.getElementById('p_codigoUnico').value; const anio=document.getElementById('p_anio').value; const dia=document.getElementById('p_dia').value; const mes=document.getElementById('p_mes').value; const nombreAnio=document.getElementById('p_nombreAnio').value;
        const fechaTexto=`${dia} de ${mes} del ${anio}`;
        const children=[]; children.push(...construirEncabezado(logoArrayBuffer, fechaTexto, nombreAnio));
        children.push(new Paragraph({children:[new TextRun({text:`OFICIO N¬∞ (${codigo}) ${anio}-MP-FN-2D-1FPCEDCF-LIMA.`,bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        // ... (Resumen del cuerpo para brevedad, sigue tu l√≥gica V34) ...
        children.push(new Paragraph({children:[new TextRun({text:"SE√ëORES:",bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"UNIDAD DE PERITOS FECOF",bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"PRESENTE.-",bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        // Aqu√≠ agregas el resto de tu l√≥gica de Pericias V34...
        crearYDescargarDoc(children, `Oficio_Pericia_${codigo}.docx`);
    }

    // Generar Movilidad
    function generarWordMovilidad() {
        const {Document,Packer,Paragraph,TextRun,AlignmentType,UnderlineType}=docx;
        const oficio=document.getElementById('m_numOficio').value; const nombreAnio=document.getElementById('m_nombreAnio').value; const fecha=formatearFechaLarga(document.getElementById('m_fechaDocumento').value);
        
        // Destinos
        const cant=document.getElementById('m_cantDestinos').value; let dests=[]; for(let i=1;i<=cant;i++){let v=document.getElementById(`m_tipoDestino_${i}`).value; if(v==='OTRO')v=document.getElementById(`m_destinoManual_${i}`).value; if(v)dests.push(v);}
        let destTxt=dests.join("; "); if(dests.length>1){const u=dests.pop(); destTxt=dests.join("; ")+" y "+u;}
        
        // Servicio
        let serv=document.getElementById('m_previewServicio').innerText; if(serv.includes('Selecciona')) serv="FECHA POR DEFINIR";
        
        const children=[]; children.push(...construirEncabezado(logoArrayBuffer, `Lima, ${fecha}`, nombreAnio));
        children.push(new Paragraph({children:[new TextRun({text:`OFICIO N.¬∞ ${oficio}-MP-FN-2D-1¬∞FPCEDCF-LIMA.`,bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"Sr. Dr.",bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"MIRKO DINO CANO GAMERO",bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"FISCAL ADJUNTO SUPREMO TITULAR COORDINADOR NACIONAL DE LAS FISCAL√çAS ESPECIALIZADAS EN DELITOS DE CORRUPCI√ìN DE FUNCIONARIOS.",bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"PRESENTE.-",bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({text:"",spacing:{line:276}}));
        children.push(new Paragraph({indent:{left:4000},children:[new TextRun({text:"ASUNTO: SOLICITUD DE ATENCI√ìN DE MOVILIDAD",bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({text:"",spacing:{line:276}}));
        
        // P√°rrafos
        const p1=new Paragraph({alignment:AlignmentType.JUSTIFIED,spacing:{line:276},children:[new TextRun({text:"Tengo el honor de dirigirme a usted, a fin de saludarlo cordialmente, y a su vez, SOLICITAR, la asignaci√≥n de una movilidad (Veh√≠culo institucional) para nuestro despacho Fiscal, con el fin de poder trasladarnos a: ",size:24,font:"Arial Narrow"}),new TextRun({text:destTxt,bold:true,size:24,font:"Arial Narrow"}),new TextRun({text:"; y as√≠ dar cumplimiento con las diligencias pendientes, por lo que se solicita apoyo con car√°cter de ",size:24,font:"Arial Narrow"}),new TextRun({text:"MUY URGENTE",bold:true,size:24,font:"Arial Narrow"}),new TextRun({text:", el veh√≠culo institucional.",size:24,font:"Arial Narrow"})]});
        children.push(p1); children.push(new Paragraph({text:""}));
        
        const p2=new Paragraph({alignment:AlignmentType.JUSTIFIED,spacing:{line:276},children:[new TextRun({text:"En ese sentido, el 2¬∞ Despacho de la 1¬∞ Fiscal√≠a Provincial Corporativa Especializada en Delitos de Corrupci√≥n de Funcionarios de Lima Centro, cumple con ",size:24,font:"Arial Narrow"}),new TextRun({text:"SOLICITAR",bold:true,size:24,font:"Arial Narrow"}),new TextRun({text:" que nos ASIGNEN un veh√≠culo para el d√≠a ",size:24,font:"Arial Narrow"}),new TextRun({text:serv,bold:true,size:24,font:"Arial Narrow"}),new TextRun({text:".",size:24,font:"Arial Narrow"})]});
        children.push(p2); children.push(new Paragraph({text:""}));
        
        // Contacto
        let cel=document.getElementById('m_comboCelular').value; if(cel==='OTRO')cel=document.getElementById('m_celularManual').value;
        let asis=document.getElementById('m_comboAsistente').value; if(asis==='OTRO')asis=document.getElementById('m_asistenteManual').value;
        const p3=new Paragraph({alignment:AlignmentType.JUSTIFIED,spacing:{line:276},children:[new TextRun({text:"Para efectos de la confirmaci√≥n de la solicitud, y de toda coordinaci√≥n, se pone de conocimiento el correo de Mesa de Partes del Despacho: ",size:24,font:"Arial Narrow"}),new TextRun({text:"fecoflima_1f2d@mpfn.gob.pe",bold:true,size:24,font:"Arial Narrow"}),new TextRun({text:"; as√≠ como el tel√©fono celular N¬∞ ",size:24,font:"Arial Narrow"}),new TextRun({text:cel,bold:true,size:24,font:"Arial Narrow"}),new TextRun({text:" perteneciente a la Asistente en Funci√≥n Fiscal ",size:24,font:"Arial Narrow"}),new TextRun({text:asis,bold:true,size:24,font:"Arial Narrow"}),new TextRun({text:".",size:24,font:"Arial Narrow"})]});
        children.push(p3); children.push(new Paragraph({text:""}));
        children.push(new Paragraph({alignment:AlignmentType.JUSTIFIED,spacing:{line:276},children:[new TextRun({text:"Sin otro particular, aprovecho la ocasi√≥n para expresarle las muestras de mi especial consideraci√≥n y estima personal.",size:24,font:"Arial Narrow"})]}));
        children.push(new Paragraph({text:"\n\n"}));
        children.push(new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Atentamente,",size:24,font:"Arial Narrow"})]}));
        
        crearYDescargarDoc(children, `Oficio_Movilidad_${oficio}.docx`);
    }

    // Generar Atenci√≥n (NUEVO)
    function generarWordAtencion() {
        const {Document,Packer,Paragraph,TextRun,AlignmentType,UnderlineType}=docx;
        const oficio=document.getElementById('a_oficio').value; const fecha=formatearFechaLarga(document.getElementById('a_fecha').value); const nombreAnio=document.getElementById('a_nombreAnio').value;
        const destN=document.getElementById('a_dest_nombre').value; const destC=document.getElementById('a_dest_cargo').value;
        const saludo=document.getElementById('a_saludo').value; const tiene=document.getElementById('a_tieneInfo').value;
        
        let refs=[]; for(let i=0;i<refCount;i++){let v=document.getElementById(`ref_input_${i}`)?.value; if(v)refs.push(`${letras[i]} ${v}`);}
        let refTxt=refs.join("  ");

        const children=[]; children.push(...construirEncabezado(logoArrayBuffer, `Lima, ${fecha}`, nombreAnio));
        children.push(new Paragraph({children:[new TextRun({text:`OFICIO N¬∞ ${oficio}`,bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"Sr. (a) Dr. (a)",bold:false,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:destN,bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:destC,bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({children:[new TextRun({text:"PRESENTE.-",bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({text:"",spacing:{line:276}}));
        children.push(new Paragraph({indent:{left:4000},children:[new TextRun({text:"ASUNTO: ATIENDE PEDIDO DE INFORMACI√ìN",bold:true,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        if(refTxt) children.push(new Paragraph({indent:{left:4000},children:[new TextRun({text:`Referencia: ${refTxt}`,size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        children.push(new Paragraph({text:"",spacing:{line:276}}));

        // Cuerpo Din√°mico
        let runs=[ new TextRun({text:`${saludo} a usted, en mi condici√≥n de Fiscal Provincial del Segundo Despacho de la Primera Fiscal√≠a Provincial Corporativa Especializada en Delitos de Corrupci√≥n de Funcionarios de Lima Centro, y en atenci√≥n a lo solicitado en el documento de la referencia, `,size:24,font:"Arial Narrow"}), new TextRun({text:"CUMPLO CON INFORMAR",bold:true,size:24,font:"Arial Narrow"}) ];
        if(tiene==='NO'){
            runs.push(new TextRun({text:" que este despacho ",size:24,font:"Arial Narrow"}));
            runs.push(new TextRun({text:"NO CUENTA",bold:true,size:24,font:"Arial Narrow"}));
            runs.push(new TextRun({text:" con investigaciones relacionadas con los hechos materia del requerimiento.",size:24,font:"Arial Narrow"}));
        } else {
            const carpetas=document.getElementById('a_carpetas').value;
            runs.push(new TextRun({text:" que este despacho ",size:24,font:"Arial Narrow"}));
            runs.push(new TextRun({text:"S√ç CUENTA",bold:true,size:24,font:"Arial Narrow"}));
            runs.push(new TextRun({text:" con investigaciones relacionadas con los hechos materia del requerimiento, encontr√°ndose los mismos comprendidos en las Carpetas Fiscales ",size:24,font:"Arial Narrow"}));
            runs.push(new TextRun({text:carpetas,bold:true,size:24,font:"Arial Narrow"}));
            runs.push(new TextRun({text:".",size:24,font:"Arial Narrow"}));
        }
        children.push(new Paragraph({alignment:AlignmentType.JUSTIFIED,spacing:{line:276},children:runs}));

        if(tiene==='SI'){
            const d=document.getElementById('chk_dispo').checked; const dc=document.getElementById('chk_declara').checked;
            let adj=""; if(d&&dc)adj="las disposiciones fiscales y declaraciones pertinentes"; else if(d)adj="las disposiciones fiscales pertinentes"; else if(dc)adj="las declaraciones pertinentes";
            if(adj){ children.push(new Paragraph({text:""})); children.push(new Paragraph({alignment:AlignmentType.JUSTIFIED,spacing:{line:276},children:[new TextRun({text:"En tal sentido, se adjuntan ",size:24,font:"Arial Narrow"}),new TextRun({text:adj,size:24,font:"Arial Narrow"}),new TextRun({text:" para conocimiento y fines correspondientes.",size:24,font:"Arial Narrow"})]})); }
        }

        children.push(new Paragraph({text:""}));
        children.push(new Paragraph({alignment:AlignmentType.JUSTIFIED,spacing:{line:276},children:[new TextRun({text:"Sin otro particular, renuevo a usted las expresiones de mi especial consideraci√≥n y estima personal.",size:24,font:"Arial Narrow"})]}));
        children.push(new Paragraph({text:"\n\n"}));
        children.push(new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Atentamente,",size:24,font:"Arial Narrow"})]}));
        children.push(new Paragraph({children:[new TextRun({text:"NICA/ djsa.",size:20,font:"Arial Narrow"})]}));

        crearYDescargarDoc(children, `Oficio_Atencion_${oficio.split('-')[0]}.docx`);
    }

    // Chat Generador
    function generarWordMovilidadChat() {
        datos['m_oficio']=datos['m_oficio']||""; datos['m_fecha']=datos['m_fecha']||""; datos['m_servicio']=datos['m_servicio']||""; datos['m_celular']=datos['m_celular']||"957691331"; datos['m_asistente']=datos['m_asistente']||"DEBORA";
        // Simulamos inputs DOM ocultos para reutilizar l√≥gica
        // O m√°s f√°cil, usar el objeto datos directamente
        const {Document,Packer,Paragraph,TextRun,AlignmentType,UnderlineType}=docx;
        const fecha=formatearFechaLarga(datos['m_fecha']);
        const oficio=datos['m_oficio'];
        let dests=[]; Object.keys(datos).forEach(k=>{if(k.startsWith('m_lugar_'))dests.push(datos[k]);});
        let destTxt=dests.join("; ");
        
        const children=[]; children.push(...construirEncabezado(logoArrayBuffer, `Lima, ${fecha}`, "")); // Chat no pregunta a√±o aun
        children.push(new Paragraph({children:[new TextRun({text:`OFICIO N.¬∞ ${oficio}-MP-FN-2D-1¬∞FPCEDCF-LIMA.`,bold:true,underline:{type:UnderlineType.SINGLE},size:24,font:"Arial Narrow"})],spacing:{line:276}}));
        // ... (Cuerpo abreviado, usa la l√≥gica completa de arriba si deseas perfecci√≥n, aqu√≠ pongo lo b√°sico para que funcione el chat)
        children.push(new Paragraph({children:[new TextRun({text:"ASUNTO: SOLICITUD MOVILIDAD (Voz)",bold:true,size:24,font:"Arial Narrow"})],indent:{left:4000}}));
        children.push(new Paragraph({children:[new TextRun({text:`Destino: ${destTxt}. Servicio: ${datos['m_servicio']}`,size:24,font:"Arial Narrow"})]}));
        crearYDescargarDoc(children, `Movilidad_Voz_${oficio}.docx`);
    }

    function crearYDescargarDoc(children, nombreArchivo) { const {Document,Packer,Footer,Paragraph,TextRun}=docx; const doc=new Document({sections:[{properties:{pageMargins:{top:567,right:1701,bottom:1417,left:1701}},children:children,footers:{default:new Footer({children:[new Paragraph({children:[new TextRun({text:"Tel√©fono: (01) 625-5555", size:22, font:"Arial Narrow", color:"333333"})]}),new Paragraph({children:[new TextRun({text:"Anexos: 11706 / 11705", size:22, font:"Arial Narrow", color:"333333"})]}),new Paragraph({children:[new TextRun({text:"E-mail: fecoflima_1f2d@mpfn.gob.pe", size:22, font:"Arial Narrow", color:"333333"})]}),new Paragraph({children:[new TextRun({text:"Direcci√≥n: Jr. Lampa N.¬∞ 597 ‚Äì Cercado de Lima.", size:22, font:"Arial Narrow", color:"333333"})]})]})}}]}); Packer.toBlob(doc).then(blob => { saveAs(blob, nombreArchivo); }); }
</script>
</body>
</html>
